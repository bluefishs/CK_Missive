name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  frontend-check:
    name: Frontend TypeScript & ESLint
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: ESLint check
        run: npx eslint src --ext .ts,.tsx --max-warnings 0

  backend-check:
    name: Backend Python Checks
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Python syntax check
        run: |
          python -m py_compile main.py
          python -m py_compile app/core/config.py
          python -m py_compile app/core/dependencies.py
          python -m py_compile app/db/database.py

      - name: Validate configuration
        run: |
          python -c "
          from app.core.config import settings
          print('=== Configuration Validation ===')
          print(f'DATABASE_URL configured: {bool(settings.DATABASE_URL)}')
          print(f'POSTGRES_PASSWORD configured: {bool(settings.POSTGRES_PASSWORD)}')
          print(f'Config validation: {settings.validate_database_config()}')
          print('Config OK')
          "

      - name: Run basic import test
        run: |
          python -c "from app.core.config import settings; print('Config OK')"

      - name: Run unit tests
        run: |
          pip install pytest pytest-asyncio
          python -m pytest tests/unit/ -v --tb=short

  config-consistency:
    name: Configuration Consistency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for duplicate .env files
        run: |
          echo "=== Checking for configuration consistency ==="

          # 檢查 backend/.env 是否存在（不應該存在）
          if [ -f "backend/.env" ]; then
            echo "⚠️ WARNING: backend/.env exists!"
            echo "建議使用專案根目錄的 .env 作為唯一設定來源"
            exit 1
          else
            echo "✓ No duplicate backend/.env found"
          fi

          # 確認根目錄 .env.example 存在
          if [ -f ".env" ] || [ -f ".env.example" ]; then
            echo "✓ Root .env configuration exists"
          fi

          echo "=== Configuration check passed ==="

  skills-sync-check:
    name: Skills & Config Sync Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make script executable
        run: chmod +x scripts/skills-sync-check.sh

      - name: Run Skills sync check
        run: ./scripts/skills-sync-check.sh

      - name: Verify CLAUDE.md exists
        run: |
          if [ -f "CLAUDE.md" ]; then
            echo "✓ CLAUDE.md exists"
            # Check version
            VERSION=$(grep -oP 'Claude Code 配置版本.*?(\d+\.\d+\.\d+)' CLAUDE.md | grep -oP '\d+\.\d+\.\d+' || echo "unknown")
            echo "  Version: $VERSION"
          else
            echo "✗ CLAUDE.md not found"
            exit 1
          fi

      - name: Check specifications count
        run: |
          SPEC_COUNT=$(find docs/specifications -name "*.md" 2>/dev/null | wc -l)
          echo "Found $SPEC_COUNT specification files"
          if [ "$SPEC_COUNT" -lt 10 ]; then
            echo "⚠️ Warning: Expected at least 10 specifications, found $SPEC_COUNT"
          else
            echo "✓ Specification count OK"
          fi

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Frontend npm audit
        working-directory: frontend
        run: |
          echo "=== Running npm audit ==="
          npm ci --ignore-scripts
          npm audit --audit-level=high || echo "⚠️ Some high/critical vulnerabilities found"
        continue-on-error: true

      - name: Backend dependency check
        working-directory: backend
        run: |
          echo "=== Checking Python dependencies ==="
          pip install pip-audit
          pip-audit -r requirements.txt || echo "⚠️ Some vulnerabilities found"
        continue-on-error: true

      - name: Bandit security scan
        working-directory: backend
        run: |
          echo "=== Running Bandit Python security scanner ==="
          pip install bandit
          # 掃描 app 目錄，排除測試，中等及以上嚴重性
          bandit -r app -ll -ii --exclude tests -f txt || echo "⚠️ Some security issues found"
        continue-on-error: true

      - name: Check for hardcoded secrets
        run: |
          echo "=== Checking for potential hardcoded secrets ==="
          # 檢查常見的硬編碼密碼模式 (排除測試和範例檔案)
          if grep -rn --include="*.py" --include="*.ts" --include="*.tsx" \
             -E "(password\s*=\s*['\"][^'\"]+['\"]|api_key\s*=\s*['\"][^'\"]+['\"])" \
             --exclude-dir=node_modules --exclude-dir=__pycache__ \
             --exclude="*test*" --exclude="*.example*" \
             backend/app frontend/src 2>/dev/null | grep -v "password\s*=\s*['\"]['\"]\s*$" | head -20; then
            echo "⚠️ Warning: Potential hardcoded secrets found (review manually)"
          else
            echo "✓ No obvious hardcoded secrets detected"
          fi
        continue-on-error: true

      - name: Check for dangerous patterns
        run: |
          echo "=== Checking for dangerous patterns ==="
          # SQL 注入風險
          SQL_COUNT=$(grep -rn --include="*.py" "f\".*SELECT.*{" backend/app 2>/dev/null | wc -l)
          echo "Potential SQL injection patterns: $SQL_COUNT"

          # eval/exec 使用
          EVAL_COUNT=$(grep -rn --include="*.py" -E "\b(eval|exec)\s*\(" backend/app 2>/dev/null | wc -l)
          echo "eval/exec usage count: $EVAL_COUNT"

          echo "=== Security scan complete ==="

  # ==========================================================================
  # Docker 建置驗證 (v1.21.0 新增)
  # ==========================================================================
  docker-build:
    name: Docker Build Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: ck-missive-backend:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: ck-missive-frontend:ci
          build-args: |
            VITE_API_BASE_URL=http://localhost:8001/api
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================================================
  # 測試覆蓋率報告 (v1.21.0 新增)
  # ==========================================================================
  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # Backend coverage
      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: Run backend tests with coverage
        working-directory: backend
        run: |
          python -m pytest tests/unit/ -v --cov=app --cov-report=xml --cov-report=term-missing
        continue-on-error: true

      # Frontend coverage
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests with coverage
        working-directory: frontend
        run: |
          npm test -- --run --coverage
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml,./frontend/coverage/coverage-final.json
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

  # ==========================================================================
  # Alembic 遷移檢查 (v1.21.0 新增)
  # ==========================================================================
  migration-check:
    name: Database Migration Check
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Alembic migration status
        working-directory: backend
        env:
          DATABASE_URL: postgresql+asyncpg://test_user:test_password@localhost:5432/test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
          SECRET_KEY: test-secret-key-for-ci
        run: |
          echo "=== Alembic Migration Check ==="

          # 檢查是否有多個 head
          HEADS=$(alembic heads 2>/dev/null | wc -l)
          echo "Migration heads count: $HEADS"

          if [ "$HEADS" -gt 1 ]; then
            echo "⚠️ Warning: Multiple migration heads detected!"
            alembic heads
            exit 1
          fi

          # 顯示當前狀態
          echo "Current migration status:"
          alembic current || echo "No migrations applied yet"

          # 嘗試升級到最新
          echo "Testing migration upgrade..."
          alembic upgrade head

          echo "✓ Migration check passed"
