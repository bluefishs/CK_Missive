# =============================================================================
# CK_Missive è‡ªå‹•éƒ¨ç½²å·¥ä½œæµ (CD - Continuous Deployment)
# =============================================================================
# è§¸ç™¼æ¢ä»¶ï¼š
# 1. main åˆ†æ”¯æ¨é€å¾Œè‡ªå‹•éƒ¨ç½²åˆ° production
# 2. develop åˆ†æ”¯æ¨é€å¾Œè‡ªå‹•éƒ¨ç½²åˆ° staging
# 3. æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
# =============================================================================

name: CD - Deploy

# è‡ªå‹•è§¸ç™¼å·²åœç”¨ä»¥ç¯€çœ GitHub Actions è²»ç”¨ (2026-02-09)
# å¦‚éœ€æ¢å¾©ï¼Œå–æ¶ˆä¸‹æ–¹ push è¨»è§£
# on:
#   push:
#     branches:
#       - main
#       - develop
#     paths-ignore:
#       - '**.md'
#       - 'docs/**'
#       - '.claude/**'

on:
  # åƒ…æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'è·³éæ¸¬è©¦ (ç·Šæ€¥éƒ¨ç½²ç”¨)'
        required: false
        default: false
        type: boolean

# ç¢ºä¿åŒä¸€ç’°å¢ƒåªæœ‰ä¸€å€‹éƒ¨ç½²åœ¨é€²è¡Œ
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend

jobs:
  # ==========================================================================
  # æº–å‚™éšæ®µï¼šæ±ºå®šéƒ¨ç½²ç’°å¢ƒ
  # ==========================================================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENV="staging"
          else
            ENV="none"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "should_deploy=$([[ $ENV != 'none' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Deployment environment: $ENV"

      - name: Generate version
        id: version
        run: |
          VERSION=$(date +%Y%m%d)-$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

  # ==========================================================================
  # æ¸¬è©¦éšæ®µï¼šç¢ºä¿ç¨‹å¼ç¢¼å“è³ª
  # ==========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_deploy == 'true' && github.event.inputs.skip_tests != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: frontend
        run: npm test -- --run

      - name: Install backend dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run backend tests
        working-directory: backend
        run: python -m pytest tests/unit/ -v --tb=short

  # ==========================================================================
  # å»ºç½®éšæ®µï¼šå»ºæ§‹ Docker æ˜ åƒæª”
  # ==========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [prepare, test]
    if: always() && needs.prepare.outputs.should_deploy == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ needs.prepare.outputs.version }}
            ${{ env.BACKEND_IMAGE }}:${{ needs.prepare.outputs.environment }}
            ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ENVIRONMENT=${{ needs.prepare.outputs.environment }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ needs.prepare.outputs.version }}
            ${{ env.FRONTEND_IMAGE }}:${{ needs.prepare.outputs.environment }}
            ${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}
            VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}

  # ==========================================================================
  # éƒ¨ç½²éšæ®µï¼šéƒ¨ç½²åˆ°ç›®æ¨™ä¼ºæœå™¨
  # ==========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: needs.prepare.outputs.environment == 'staging'
    environment:
      name: staging
      url: ${{ secrets.STAGING_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.STAGING_DEPLOY_PATH }}

            # å‚™ä»½ç•¶å‰ç‰ˆæœ¬
            echo "ğŸ“¦ Backing up current version..."
            docker-compose -f docker-compose.unified.yml ps > /tmp/pre-deploy-status.txt

            # æ‹‰å–æœ€æ–°æ˜ åƒæª”
            echo "ğŸ”„ Pulling latest images..."
            docker pull ${{ env.BACKEND_IMAGE }}:staging
            docker pull ${{ env.FRONTEND_IMAGE }}:staging

            # æ›´æ–°æœ¬åœ°æ¨™ç±¤
            docker tag ${{ env.BACKEND_IMAGE }}:staging ck-missive-backend:latest
            docker tag ${{ env.FRONTEND_IMAGE }}:staging ck-missive-frontend:latest

            # é‡å•Ÿæœå‹™
            echo "ğŸš€ Restarting services..."
            docker-compose -f docker-compose.unified.yml up -d --force-recreate backend frontend

            # ç­‰å¾…æœå‹™å•Ÿå‹•
            echo "â³ Waiting for services to be healthy..."
            sleep 30

            # å¥åº·æª¢æŸ¥
            echo "ğŸ¥ Running health checks..."
            curl -f http://localhost:8001/health || exit 1

            echo "âœ… Staging deployment completed!"

      - name: Notify deployment success
        if: success()
        run: |
          echo "ğŸ‰ Staging deployment successful!"
          echo "Version: ${{ needs.prepare.outputs.version }}"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: needs.prepare.outputs.environment == 'production'
    environment:
      name: production
      url: ${{ secrets.PRODUCTION_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: ${{ secrets.PRODUCTION_SSH_PORT || 22 }}
          script: |
            cd ${{ secrets.PRODUCTION_DEPLOY_PATH }}

            # å‚™ä»½è³‡æ–™åº«
            echo "ğŸ’¾ Backing up database..."
            docker exec ck_missive_postgres pg_dump -U $POSTGRES_USER $POSTGRES_DB > /tmp/backup-$(date +%Y%m%d%H%M%S).sql

            # å‚™ä»½ç•¶å‰ç‰ˆæœ¬
            echo "ğŸ“¦ Backing up current version..."
            docker-compose -f docker-compose.unified.yml ps > /tmp/pre-deploy-status.txt

            # æ‹‰å–æœ€æ–°æ˜ åƒæª”
            echo "ğŸ”„ Pulling latest images..."
            docker pull ${{ env.BACKEND_IMAGE }}:production
            docker pull ${{ env.FRONTEND_IMAGE }}:production

            # æ›´æ–°æœ¬åœ°æ¨™ç±¤
            docker tag ${{ env.BACKEND_IMAGE }}:production ck-missive-backend:latest
            docker tag ${{ env.FRONTEND_IMAGE }}:production ck-missive-frontend:latest

            # åŸ·è¡Œè³‡æ–™åº«é·ç§»
            echo "ğŸ—ƒï¸ Running database migrations..."
            docker-compose -f docker-compose.unified.yml exec -T backend alembic upgrade head

            # è—ç¶ éƒ¨ç½²ï¼šå…ˆå•Ÿå‹•æ–°æœå‹™
            echo "ğŸš€ Starting new services..."
            docker-compose -f docker-compose.unified.yml up -d --force-recreate backend frontend

            # ç­‰å¾…æœå‹™å•Ÿå‹•
            echo "â³ Waiting for services to be healthy..."
            sleep 45

            # å¥åº·æª¢æŸ¥
            echo "ğŸ¥ Running health checks..."
            for i in 1 2 3; do
              if curl -sf http://localhost:8001/health; then
                echo "âœ… Health check passed!"
                break
              fi
              echo "âš ï¸ Health check attempt $i failed, retrying..."
              sleep 10
            done

            # æ¸…ç†èˆŠæ˜ åƒæª”
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "âœ… Production deployment completed!"

      - name: Notify deployment success
        if: success()
        run: |
          echo "ğŸ‰ Production deployment successful!"
          echo "Version: ${{ needs.prepare.outputs.version }}"

  # ==========================================================================
  # å›æ»¾æ©Ÿåˆ¶ (æ‰‹å‹•è§¸ç™¼)
  # ==========================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()

    steps:
      - name: Trigger rollback
        run: |
          echo "âš ï¸ Deployment failed! Manual rollback may be required."
          echo "To rollback, run on the server:"
          echo "  docker-compose -f docker-compose.unified.yml down"
          echo "  docker tag ck-missive-backend:previous ck-missive-backend:latest"
          echo "  docker tag ck-missive-frontend:previous ck-missive-frontend:latest"
          echo "  docker-compose -f docker-compose.unified.yml up -d"

  # ==========================================================================
  # éƒ¨ç½²é€šçŸ¥
  # ==========================================================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging, deploy-production]
    if: always() && needs.prepare.outputs.should_deploy == 'true'

    steps:
      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "ğŸ“‹ Deployment Summary"
          echo "=========================================="
          echo "Environment: ${{ needs.prepare.outputs.environment }}"
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "Staging: ${{ needs.deploy-staging.result || 'skipped' }}"
          echo "Production: ${{ needs.deploy-production.result || 'skipped' }}"
          echo "=========================================="
