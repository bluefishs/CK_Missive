# =============================================================================
# CK_Missive ç”Ÿç”¢ç’°å¢ƒè‡ªå‹•éƒ¨ç½²å·¥ä½œæµ
# =============================================================================
# ç‰ˆæœ¬: 1.0.0
# å»ºç«‹æ—¥æœŸ: 2026-02-02
#
# è§¸ç™¼æ¢ä»¶:
#   - Push tag (v*)
#   - æ‰‹å‹•è§¸ç™¼ (workflow_dispatch)
#
# å‰ç½®éœ€æ±‚:
#   1. åœ¨ QNAP NAS ä¸Šè¨­ç½® self-hosted runner
#   2. é…ç½® GitHub Secrets (è¦‹ä¸‹æ–¹èªªæ˜)
#
# å¿…è¦ Secrets:
#   - DEPLOY_PATH: NAS ä¸Šçš„éƒ¨ç½²è·¯å¾‘ (ä¾‹: /share/CACHEDEV1_DATA/Container/ck-missive)
#   - SLACK_WEBHOOK_URL: (å¯é¸) Slack é€šçŸ¥ Webhook
# =============================================================================

name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_backup:
        description: 'è·³éå‚™ä»½æ­¥é©Ÿ'
        required: false
        default: 'false'
        type: boolean
      force_rebuild:
        description: 'å¼·åˆ¶é‡æ–°å»ºç½® (ä¸ä½¿ç”¨å¿«å–)'
        required: false
        default: 'false'
        type: boolean

# ç¢ºä¿åŒæ™‚åªæœ‰ä¸€å€‹éƒ¨ç½²åœ¨åŸ·è¡Œ
concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/share/CACHEDEV1_DATA/Container/ck-missive' }}
  COMPOSE_FILE: docker-compose.production.yml
  HEALTH_CHECK_TIMEOUT: 60
  HEALTH_CHECK_INTERVAL: 5

jobs:
  # ===========================================================================
  # Job 1: é©—è­‰èˆ‡æº–å‚™
  # ===========================================================================
  validate:
    name: é©—è­‰éƒ¨ç½²æ¢ä»¶
    runs-on: self-hosted
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å–å¾—ç‰ˆæœ¬è™Ÿ
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="manual-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ éƒ¨ç½²ç‰ˆæœ¬: $VERSION"

      - name: æª¢æŸ¥éƒ¨ç½²è·¯å¾‘
        id: check
        run: |
          if [ -d "${{ env.DEPLOY_PATH }}" ]; then
            echo "âœ… éƒ¨ç½²è·¯å¾‘å­˜åœ¨: ${{ env.DEPLOY_PATH }}"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ éƒ¨ç½²è·¯å¾‘ä¸å­˜åœ¨: ${{ env.DEPLOY_PATH }}"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: æª¢æŸ¥ Docker æœå‹™
        run: |
          docker --version
          docker compose version
          echo "âœ… Docker æœå‹™æ­£å¸¸"

  # ===========================================================================
  # Job 2: å‚™ä»½ç•¶å‰ç‰ˆæœ¬
  # ===========================================================================
  backup:
    name: å‚™ä»½ç•¶å‰ç‰ˆæœ¬
    runs-on: self-hosted
    needs: validate
    if: ${{ needs.validate.outputs.should_deploy == 'true' && github.event.inputs.skip_backup != 'true' }}

    steps:
      - name: å‚™ä»½ Docker æ˜ åƒ
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "ğŸ”„ å‚™ä»½ç•¶å‰ Docker æ˜ åƒ..."

          # æ¨™è¨˜ç•¶å‰æ˜ åƒç‚º rollback
          docker tag ck-missive-backend:latest ck-missive-backend:rollback 2>/dev/null || echo "âš ï¸ å¾Œç«¯æ˜ åƒä¸å­˜åœ¨ï¼Œè·³éå‚™ä»½"
          docker tag ck-missive-frontend:latest ck-missive-frontend:rollback 2>/dev/null || echo "âš ï¸ å‰ç«¯æ˜ åƒä¸å­˜åœ¨ï¼Œè·³éå‚™ä»½"

          echo "âœ… æ˜ åƒå‚™ä»½å®Œæˆ"

      - name: å‚™ä»½è³‡æ–™åº« (å¯é¸)
        working-directory: ${{ env.DEPLOY_PATH }}
        continue-on-error: true
        run: |
          echo "ğŸ”„ å‚™ä»½è³‡æ–™åº«..."

          # å»ºç«‹å‚™ä»½ç›®éŒ„
          BACKUP_DIR="backups/pre-deploy-$(date +%Y%m%d-%H%M%S)"
          mkdir -p "$BACKUP_DIR"

          # åŸ·è¡Œè³‡æ–™åº«å‚™ä»½
          docker compose -f ${{ env.COMPOSE_FILE }} exec -T postgres pg_dump -U ck_user ck_documents > "$BACKUP_DIR/database.sql" 2>/dev/null || echo "âš ï¸ è³‡æ–™åº«å‚™ä»½è·³é"

          echo "âœ… è³‡æ–™åº«å‚™ä»½å®Œæˆ"

  # ===========================================================================
  # Job 3: å»ºç½®èˆ‡éƒ¨ç½²
  # ===========================================================================
  deploy:
    name: å»ºç½®èˆ‡éƒ¨ç½²
    runs-on: self-hosted
    needs: [validate, backup]
    if: ${{ always() && needs.validate.outputs.should_deploy == 'true' }}
    outputs:
      deploy_status: ${{ steps.deploy.outputs.status }}

    steps:
      - name: æ›´æ–°ç¨‹å¼ç¢¼
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "ğŸ”„ æ›´æ–°ç¨‹å¼ç¢¼..."
          git fetch --all --tags

          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            git checkout ${{ github.ref_name }}
          else
            git checkout ${{ github.sha }}
          fi

          echo "âœ… ç¨‹å¼ç¢¼æ›´æ–°å®Œæˆ"

      - name: å»ºç½® Docker æ˜ åƒ
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "ğŸ”„ å»ºç½® Docker æ˜ åƒ..."

          BUILD_ARGS=""
          if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            BUILD_ARGS="--no-cache"
          fi

          docker compose -f ${{ env.COMPOSE_FILE }} build $BUILD_ARGS

          echo "âœ… æ˜ åƒå»ºç½®å®Œæˆ"

      - name: åœæ­¢èˆŠæœå‹™
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "ğŸ”„ åœæ­¢èˆŠæœå‹™..."
          docker compose -f ${{ env.COMPOSE_FILE }} down --remove-orphans || true
          echo "âœ… èˆŠæœå‹™å·²åœæ­¢"

      - name: å•Ÿå‹•æ–°æœå‹™
        id: deploy
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "ğŸ”„ å•Ÿå‹•æ–°æœå‹™..."
          docker compose -f ${{ env.COMPOSE_FILE }} up -d

          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… æ–°æœå‹™å·²å•Ÿå‹•"

      - name: ç­‰å¾…æœå‹™å•Ÿå‹•
        run: |
          echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
          sleep 15

  # ===========================================================================
  # Job 4: å¥åº·æª¢æŸ¥
  # ===========================================================================
  health-check:
    name: å¥åº·æª¢æŸ¥
    runs-on: self-hosted
    needs: deploy
    if: ${{ needs.deploy.outputs.deploy_status == 'success' }}
    outputs:
      health_status: ${{ steps.check.outputs.status }}

    steps:
      - name: å¾Œç«¯å¥åº·æª¢æŸ¥
        id: backend
        run: |
          echo "ğŸ” æª¢æŸ¥å¾Œç«¯æœå‹™..."

          TIMEOUT=${{ env.HEALTH_CHECK_TIMEOUT }}
          INTERVAL=${{ env.HEALTH_CHECK_INTERVAL }}
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -sf http://localhost:8001/health > /dev/null 2>&1; then
              echo "âœ… å¾Œç«¯æœå‹™æ­£å¸¸"
              exit 0
            fi
            echo "â³ ç­‰å¾…å¾Œç«¯æœå‹™... ($ELAPSED/$TIMEOUT ç§’)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "âŒ å¾Œç«¯æœå‹™å¥åº·æª¢æŸ¥å¤±æ•—"
          exit 1

      - name: å‰ç«¯å¥åº·æª¢æŸ¥
        id: frontend
        run: |
          echo "ğŸ” æª¢æŸ¥å‰ç«¯æœå‹™..."

          TIMEOUT=${{ env.HEALTH_CHECK_TIMEOUT }}
          INTERVAL=${{ env.HEALTH_CHECK_INTERVAL }}
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -sf http://localhost:3000 > /dev/null 2>&1; then
              echo "âœ… å‰ç«¯æœå‹™æ­£å¸¸"
              exit 0
            fi
            echo "â³ ç­‰å¾…å‰ç«¯æœå‹™... ($ELAPSED/$TIMEOUT ç§’)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "âŒ å‰ç«¯æœå‹™å¥åº·æª¢æŸ¥å¤±æ•—"
          exit 1

      - name: API åŠŸèƒ½æ¸¬è©¦
        id: api
        continue-on-error: true
        run: |
          echo "ğŸ” åŸ·è¡Œ API åŠŸèƒ½æ¸¬è©¦..."

          # æ¸¬è©¦ API æ–‡ä»¶ç«¯é»
          if curl -sf http://localhost:8001/docs > /dev/null 2>&1; then
            echo "âœ… API æ–‡ä»¶ç«¯é»æ­£å¸¸"
          else
            echo "âš ï¸ API æ–‡ä»¶ç«¯é»ç•°å¸¸"
          fi

          # æ¸¬è©¦è³‡æ–™åº«é€£ç·š (é€é health ç«¯é»)
          HEALTH_RESPONSE=$(curl -sf http://localhost:8001/health 2>/dev/null || echo "{}")
          echo "Health Response: $HEALTH_RESPONSE"

      - name: è¨­å®šæª¢æŸ¥ç‹€æ…‹
        id: check
        run: |
          echo "status=healthy" >> $GITHUB_OUTPUT
          echo "âœ… æ‰€æœ‰å¥åº·æª¢æŸ¥é€šé"

  # ===========================================================================
  # Job 5: å›æ»¾ (åƒ…åœ¨å¥åº·æª¢æŸ¥å¤±æ•—æ™‚åŸ·è¡Œ)
  # ===========================================================================
  rollback:
    name: å›æ»¾éƒ¨ç½²
    runs-on: self-hosted
    needs: [deploy, health-check]
    if: ${{ failure() && needs.deploy.outputs.deploy_status == 'success' }}

    steps:
      - name: åŸ·è¡Œå›æ»¾
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "ğŸ”„ åŸ·è¡Œå›æ»¾..."

          # åœæ­¢ç•¶å‰æœå‹™
          docker compose -f ${{ env.COMPOSE_FILE }} down || true

          # é‚„åŸæ˜ åƒæ¨™ç±¤
          docker tag ck-missive-backend:rollback ck-missive-backend:latest 2>/dev/null || echo "âš ï¸ ç„¡æ³•é‚„åŸå¾Œç«¯æ˜ åƒ"
          docker tag ck-missive-frontend:rollback ck-missive-frontend:latest 2>/dev/null || echo "âš ï¸ ç„¡æ³•é‚„åŸå‰ç«¯æ˜ åƒ"

          # å•Ÿå‹•æœå‹™
          docker compose -f ${{ env.COMPOSE_FILE }} up -d

          echo "âœ… å›æ»¾å®Œæˆ"

      - name: é©—è­‰å›æ»¾
        run: |
          echo "ğŸ” é©—è­‰å›æ»¾ç‹€æ…‹..."
          sleep 15

          if curl -sf http://localhost:8001/health > /dev/null 2>&1; then
            echo "âœ… å›æ»¾å¾Œæœå‹™æ­£å¸¸"
          else
            echo "âŒ å›æ»¾å¾Œæœå‹™ä»ç„¶ç•°å¸¸ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
            exit 1
          fi

  # ===========================================================================
  # Job 6: æ¸…ç†èˆ‡é€šçŸ¥
  # ===========================================================================
  cleanup:
    name: æ¸…ç†èˆ‡é€šçŸ¥
    runs-on: self-hosted
    needs: [validate, deploy, health-check]
    if: ${{ always() }}

    steps:
      - name: æ¸…ç†èˆŠæ˜ åƒ
        if: ${{ needs.health-check.outputs.health_status == 'healthy' }}
        run: |
          echo "ğŸ§¹ æ¸…ç†èˆŠæ˜ åƒ..."
          docker image prune -f
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: éƒ¨ç½²æ‘˜è¦
        run: |
          echo "=============================================="
          echo "ğŸ“‹ éƒ¨ç½²æ‘˜è¦"
          echo "=============================================="
          echo "ç‰ˆæœ¬: ${{ needs.validate.outputs.version }}"
          echo "è§¸ç™¼æ–¹å¼: ${{ github.event_name }}"
          echo "è§¸ç™¼è€…: ${{ github.actor }}"
          echo "æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""

          if [[ "${{ needs.health-check.outputs.health_status }}" == "healthy" ]]; then
            echo "ğŸ‰ éƒ¨ç½²ç‹€æ…‹: æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²ç‹€æ…‹: å¤±æ•—"
          fi
          echo "=============================================="

      - name: Slack é€šçŸ¥ (å¯é¸)
        if: ${{ always() && secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
        run: |
          if [[ "${{ needs.health-check.outputs.health_status }}" == "healthy" ]]; then
            STATUS="âœ… æˆåŠŸ"
            COLOR="good"
          else
            STATUS="âŒ å¤±æ•—"
            COLOR="danger"
          fi

          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"CK_Missive éƒ¨ç½²é€šçŸ¥\",
                \"fields\": [
                  {\"title\": \"ç‹€æ…‹\", \"value\": \"$STATUS\", \"short\": true},
                  {\"title\": \"ç‰ˆæœ¬\", \"value\": \"${{ needs.validate.outputs.version }}\", \"short\": true},
                  {\"title\": \"è§¸ç™¼è€…\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"æ™‚é–“\", \"value\": \"$(date '+%Y-%m-%d %H:%M:%S')\", \"short\": true}
                ]
              }]
            }"
