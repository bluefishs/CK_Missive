#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸é…ç½®..."

# æª¢æŸ¥æ˜¯å¦æœ‰8002ç¡¬ç·¨ç¢¼
if grep -r "localhost:8002" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=dist --exclude=pre-commit; then
  echo "âŒ ç™¼ç¾ç¡¬ç·¨ç¢¼çš„8002ç«¯å£ï¼Œè«‹ä¿®å¾©å¾Œå†æäº¤"
  exit 1
fi

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æª”æ¡ˆ
if [ -f "scripts/env-manager.js" ]; then
  node scripts/env-manager.js validate
  if [ $? -ne 0 ]; then
    echo "âŒ ç’°å¢ƒè®Šæ•¸é©—è­‰å¤±æ•—ï¼Œè«‹ä¿®å¾©å¾Œå†æäº¤"
    exit 1
  fi
fi

echo "âœ… ç’°å¢ƒè®Šæ•¸æª¢æŸ¥é€šé"

# =============================================================================
# å‹åˆ¥åŒæ­¥æª¢æŸ¥ (Type Sync Check)
# =============================================================================

echo "ğŸ” æª¢æŸ¥å‹åˆ¥å®šç¾©..."

# 1. TypeScript ç·¨è­¯æª¢æŸ¥
echo "  â³ åŸ·è¡Œ TypeScript ç·¨è­¯æª¢æŸ¥..."
npx tsc --noEmit > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "  âŒ TypeScript ç·¨è­¯å¤±æ•—ï¼Œè«‹ä¿®å¾©å‹åˆ¥éŒ¯èª¤å¾Œå†æäº¤"
  npx tsc --noEmit
  exit 1
fi
echo "  âœ… TypeScript ç·¨è­¯é€šé"

# 2. å¾Œç«¯ Schema è®Šæ›´æª¢æ¸¬
SCHEMA_CHANGED=$(git diff --cached --name-only | grep -E "backend/app/schemas/.*\.py$" || true)
if [ -n "$SCHEMA_CHANGED" ]; then
  echo "  âš ï¸  åµæ¸¬åˆ°å¾Œç«¯ Schema è®Šæ›´:"
  echo "$SCHEMA_CHANGED" | while read file; do
    echo "      - $file"
  done
  echo "  ğŸ’¡ æç¤º: å¦‚æœå¾Œç«¯æ­£åœ¨é‹è¡Œï¼Œè«‹åŸ·è¡Œ 'npm run api:generate' æ›´æ–°å‰ç«¯å‹åˆ¥"
fi

echo "âœ… å‹åˆ¥æª¢æŸ¥å®Œæˆ"
