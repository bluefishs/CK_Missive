# =============================================================================
# ä¹¾å¤æ¸¬ç¹ªå…¬æ–‡ç®¡ç†ç³»çµ± - å‰ç«¯é–‹ç™¼ç’°å¢ƒ Dockerfile
# =============================================================================
# ğŸ¯ ç›®æ¨™ï¼šé–‹ç™¼ç’°å¢ƒå°ˆç”¨ï¼Œæ”¯æ´ Vite ç†±é‡è¼‰
# ğŸ”§ åŠŸèƒ½ï¼šå³æ™‚åæ˜ ç¨‹å¼ç¢¼è®Šæ›´ï¼Œå¿«é€Ÿé–‹ç™¼é«”é©—
# =============================================================================

FROM node:18-alpine

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV NODE_ENV=development
ENV VITE_PORT=3000

# å®‰è£åŸºæœ¬å·¥å…·
RUN apk add --no-cache curl

# è¤‡è£½ package files
COPY package*.json ./

# ğŸ”¥ é–‹ç™¼ç’°å¢ƒï¼šå®‰è£æ‰€æœ‰ä¾è³´ï¼ˆåŒ…æ‹¬ devDependenciesï¼‰
RUN npm ci

# å»ºç«‹é root ä½¿ç”¨è€…
RUN addgroup -g 1000 appuser && \
    adduser -D -s /bin/sh -u 1000 -G appuser appuser

# è¨­å®šç›®éŒ„æ¬Šé™
RUN chown -R appuser:appuser /app
USER appuser

# å»ºç«‹æ—¥èªŒç›®éŒ„
RUN mkdir -p /app/logs

# å¥åº·æª¢æŸ¥ï¼ˆVite é–‹ç™¼ä¼ºæœå™¨ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:3000/ || exit 1

# æš´éœ²ç«¯å£
EXPOSE 3000

# ğŸ”¥ é–‹ç™¼æ¨¡å¼å•Ÿå‹•å‘½ä»¤ï¼šVite é–‹ç™¼ä¼ºæœå™¨
# æ³¨æ„ï¼šå¯¦éš›å‘½ä»¤æœƒåœ¨ docker-compose.dev.yml ä¸­è¦†è“‹
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "3000"]