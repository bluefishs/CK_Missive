# =============================================================================
# ä¹¾å¤æ¸¬ç¹ªå…¬æ–‡ç®¡ç†ç³»çµ± - çµ±ä¸€å‰ç«¯ Dockerfile
# =============================================================================
# ğŸ¯ ç›®æ¨™ï¼šæ¨™æº–åŒ–ã€é«˜æ•ˆèƒ½çš„å‰ç«¯å®¹å™¨å»ºç½®
# ğŸ”§ åŠŸèƒ½ï¼šå¤šéšæ®µå»ºç½®ï¼Œæœ€ä½³åŒ–ç”Ÿç”¢æ˜ åƒå¤§å°
# =============================================================================

# --- ğŸ”¨ å»ºç½®éšæ®µ ---
FROM node:18-alpine as builder

# è¨­å®šå»ºç½®åƒæ•¸
ARG VITE_API_BASE_URL=http://localhost:8001
ARG VITE_GOOGLE_CLIENT_ID=""
ARG VITE_AUTH_DISABLED=false
ARG NODE_ENV=production

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
ENV VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
ENV VITE_AUTH_DISABLED=${VITE_AUTH_DISABLED}
ENV NODE_ENV=${NODE_ENV}

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½ package files
COPY package*.json ./

# å®‰è£ä¾è³´ï¼ˆä½¿ç”¨ npm ci ä»¥ç²å¾—æ›´å¿«ã€å¯é‡ç¾çš„å»ºç½®ï¼‰
RUN npm ci --silent

# è¤‡è£½æºç¢¼
COPY . .

# å»ºç½®æ‡‰ç”¨ç¨‹å¼
RUN npm run build

# --- ğŸš€ ç”Ÿç”¢éšæ®µ ---
FROM nginx:1.25-alpine as production

# å®‰è£ curlï¼ˆç”¨æ–¼å¥åº·æª¢æŸ¥ï¼‰
RUN apk add --no-cache curl

# è¤‡è£½è‡ªå®šç¾© nginx é…ç½®
COPY nginx.conf /etc/nginx/nginx.conf

# è¤‡è£½å»ºç½®ç”¢ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å»ºç«‹æ—¥èªŒç›®éŒ„
RUN mkdir -p /app/logs && \
    chown -R nginx:nginx /app/logs

# å»ºç«‹é root ä½¿ç”¨è€…ï¼ˆå®‰å…¨æ€§æœ€ä½³å¯¦è¸ï¼‰
RUN addgroup -g 1000 appuser && \
    adduser -D -s /bin/sh -u 1000 -G appuser appuser

# è¨­å®šæ¬Šé™
RUN chown -R appuser:appuser /usr/share/nginx/html

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:80/ || exit 1

# æš´éœ²ç«¯å£
EXPOSE 80

# å•Ÿå‹• nginx
CMD ["nginx", "-g", "daemon off;"]