# =============================================================================
# CK_Missive PostgreSQL 效能調優配置
# =============================================================================
# Version: 1.0.0
# Created: 2026-02-06
# Target: PostgreSQL 15 (Docker Alpine)
# Hardware: QNAP NAS / 開發機 (4-8 GB RAM)
#
# 使用方式:
#   在 docker-compose 的 postgres 服務中掛載:
#   - ./configs/postgresql-tuning.conf:/etc/postgresql/tuning.conf:ro
#   並在 command 中加入:
#   postgres -c 'config_file=/etc/postgresql/tuning.conf'
#   或使用 -c 'include=/etc/postgresql/tuning.conf'
# =============================================================================

# ---------------------------------------------------------------------------
# 記憶體設定
# ---------------------------------------------------------------------------

# 共享緩衝區 — PostgreSQL 用於快取資料頁的記憶體
# 建議值: 系統 RAM 的 25% (4GB RAM → 1GB, 但容器限制下保守設定)
shared_buffers = 512MB

# 單次排序/雜湊操作可用記憶體
# 注意: 每個連線的每個操作都可能使用這麼多，需乘以 max_connections
work_mem = 16MB

# 維護操作 (VACUUM, CREATE INDEX) 可用記憶體
maintenance_work_mem = 128MB

# 有效快取大小 — 幫助查詢規劃器估算可用快取
# 應接近系統可用 RAM (含 OS 快取)
effective_cache_size = 1536MB

# ---------------------------------------------------------------------------
# 查詢規劃器設定
# ---------------------------------------------------------------------------

# SSD 儲存的隨機頁面讀取成本 (預設 4.0 是為 HDD 設計)
# SSD/NVMe 設為 1.1，讓規劃器更傾向使用索引掃描
random_page_cost = 1.1

# 平行查詢讀取成本
effective_io_concurrency = 200

# ---------------------------------------------------------------------------
# WAL (Write-Ahead Log) 設定
# ---------------------------------------------------------------------------

# WAL 緩衝區大小
wal_buffers = 16MB

# checkpoint 完成目標 (0-1.0)
# 較高值 = 更平滑的 I/O 但恢復較慢
checkpoint_completion_target = 0.9

# ---------------------------------------------------------------------------
# 連線設定
# ---------------------------------------------------------------------------

# 最大連線數 (需配合 SQLAlchemy pool_size + max_overflow)
# pool_size=10 + max_overflow=20 = 30 連線需求
max_connections = 50

# ---------------------------------------------------------------------------
# 日誌設定 (效能相關)
# ---------------------------------------------------------------------------

# 記錄慢查詢 (超過 500ms)
log_min_duration_statement = 500

# 記錄鎖等待
log_lock_waits = on

# 記錄臨時檔案使用 (排序溢出到磁碟)
log_temp_files = 0

# ---------------------------------------------------------------------------
# 自動清理 (Autovacuum) 調優
# ---------------------------------------------------------------------------

# 自動清理啟用
autovacuum = on

# 同時運行的 autovacuum worker 數量
autovacuum_max_workers = 3

# 較積極的清理閾值 (預設 50)
autovacuum_vacuum_threshold = 25

# 較積極的分析閾值 (預設 50)
autovacuum_analyze_threshold = 25

# ---------------------------------------------------------------------------
# 其他效能設定
# ---------------------------------------------------------------------------

# 預設統計目標 (影響 ANALYZE 精確度)
default_statistics_target = 200

# 時區
timezone = 'Asia/Taipei'

# 確保 pg_trgm 等擴展可用
# (擴展在 init.sql 中建立)
