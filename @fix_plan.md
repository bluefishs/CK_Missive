# CK_Missive Fix Plan

## ğŸ”´ High Priority (æ ¸å¿ƒåŠŸèƒ½)
- [x] å…¬æ–‡ç®¡ç†é é¢ - DocumentList æ’åºç¯©é¸åŠŸèƒ½ (Ant Design Table)
- [x] æ‰¿æ”¬æ¡ˆä»¶åˆ—è¡¨ - ContractCasePage é¡¯ç¤ºèˆ‡ CRUD åŠŸèƒ½
- [x] æ¡ˆä»¶è©³æƒ…é  - ContractCaseDetailPage å››å€‹ TAB åˆ†é æ•´åˆ (æ‰¿è¾¦åŒä»ã€å”åŠ›å» å•† CRUD)
- [x] å» å•†ç®¡ç† - VendorPage åˆ—è¡¨èˆ‡ç·¨è¼¯åŠŸèƒ½ (POST-only API)
- [x] æ©Ÿé—œå–®ä½ - AgenciesPage åˆ—è¡¨èˆ‡ç·¨è¼¯åŠŸèƒ½ (POST-only API)

## ğŸŸ¡ Medium Priority (é€²éšåŠŸèƒ½)
- [ ] è¡Œäº‹æ›†æ•´åˆ - CalendarPage èˆ‡å…¬æ–‡äº‹ä»¶é€£å‹•
- [ ] ç™¼æ–‡å­—è™Ÿç®¡ç† - DocumentNumbersPage è‡ªå‹•ç·¨è™Ÿ
- [ ] å…¬æ–‡åŒ¯å…¥/åŒ¯å‡º - DocumentImportPage, DocumentExportPage
- [ ] ä½¿ç”¨è€…æ¬Šé™ç®¡ç† - UserManagementPage, PermissionManagementPage
- [ ] Dashboard çµ±è¨ˆåœ–è¡¨å„ªåŒ–

## ğŸŸ¢ Low Priority (å„ªåŒ–é …ç›®)
- [ ] å‰ç«¯æ•ˆèƒ½å„ªåŒ– - æ¸›å°‘ API é‡è¤‡å‘¼å«
- [ ] éŒ¯èª¤è™•ç†å¼·åŒ– - çµ±ä¸€éŒ¯èª¤è¨Šæ¯æ ¼å¼
- [ ] TypeScript å‹åˆ¥å®Œå–„
- [ ] éŸ¿æ‡‰å¼è¨­è¨ˆèª¿æ•´
- [ ] å–®å…ƒæ¸¬è©¦è¦†è“‹

## âœ… Completed
- [x] Project initialization
- [x] Ralph å°ˆæ¡ˆåˆå§‹åŒ–
- [x] CodeWiki æ–‡æª”å»ºç«‹ (docs/wiki/)
- [x] Docker å®¹å™¨ç’°å¢ƒç¢ºèª
- [x] Dashboard API é©—è­‰ (502 å…¬æ–‡è³‡æ–™æ­£å¸¸)
- [x] DocumentActions çµ„ä»¶ä¿®å¾© (EyeOutlined éŒ¯èª¤)
- [x] API CORS è¨­å®šä¿®å¾©
- [x] project-vendors API 500 éŒ¯èª¤ä¿®å¾©
- [x] DocumentList æ¬„ä½æ’åºèˆ‡ç¯©é¸æ©Ÿåˆ¶ (Ant Design Table)
- [x] API å›æ‡‰æ ¼å¼è½‰æ›ä¿®å¾© (documents.ts)
- [x] DocumentList æ¬„å¯¬æœ€é©æ¯”ä¾‹å„ªåŒ– + Tooltip
- [x] ContractCasePage æ¡ˆä»¶æ€§è³ª (category) æ¨™ç±¤é¡¯ç¤ºå°æ‡‰ (01â†’01å§”è¾¦æ¡ˆä»¶ç­‰)
- [x] Vendors API èªè­‰å•é¡Œä¿®å¾© (ç§»é™¤ GET list èªè­‰éœ€æ±‚)
- [x] ProjectStaff è§’è‰²é©—è­‰ä¿®å¾© (æ“´å±• role validator æ”¯æ´å‰ç«¯é¸é …)
- [x] 422 Pydantic éŒ¯èª¤è™•ç†ä¿®å¾© (ContractCaseDetailPage éŒ¯èª¤è¨Šæ¯è§£æ)
- [x] å”åŠ›å» å•†æ¥­å‹™é¡åˆ¥æ›´æ–° (æ¸¬é‡æ¥­å‹™ã€ç³»çµ±æ¥­å‹™ã€æŸ¥ä¼°æ¥­å‹™ã€å…¶ä»–é¡åˆ¥)
- [x] å» å•†ç®¡ç†ç‡Ÿæ¥­é …ç›®æ¬„ä½ CRUD å°æ‡‰å®Œæˆ (VendorList + schema validation)
- [x] æ‰¿è¾¦åŒä»å°ˆæ¡ˆè§’è‰²æ›´æ–° (è¨ˆç•«ä¸»æŒã€è¨ˆç•«å”åŒã€å°ˆæ¡ˆPMã€è·å®‰ä¸»ç®¡)
- [x] StaffPage èˆ‡ ContractCaseDetailPage è§’è‰²é¸é …åŒæ­¥
- [x] StaffPage CRUD åŠŸèƒ½ä¿®å¾© (users.py å®Œæ•´ CRUD + schema å°æ‡‰)
- [x] å…¬æ–‡ç®¡ç†é é¢å„ªåŒ– - åˆªé™¤é‡è¤‡å„€è¡¨æ¿ã€ä¿®æ­£æ”¶ç™¼æ–‡çµ±è¨ˆã€ç¯©é¸å€æ”¶é—”
- [x] API trailing slash ä¿®å¾© - vendors.py, users.py, project_staff.py, project_vendors.py è·¯ç”±è·¯å¾‘æ”¹ç‚ºç©ºå­—ä¸²é¿å… 307/404
- [x] ContractCaseDetailPage TAB CRUD åŠŸèƒ½æ¢å¾©æ­£å¸¸ (æ‰¿è¾¦åŒä»ã€å”åŠ›å» å•†é¸å–®è¼‰å…¥)
- [x] **API æ¶æ§‹é‡æ§‹ (POST-only è³‡å®‰æ©Ÿåˆ¶)** - çµ±ä¸€å›æ‡‰æ ¼å¼èˆ‡æœå‹™å±¤æ©Ÿåˆ¶

---

## ğŸ—ï¸ API Architecture (POST-only è³‡å®‰æ©Ÿåˆ¶)

### è¨­è¨ˆåŸå‰‡
1. **POST-only ç«¯é»**: æ‰€æœ‰è³‡æ–™æ“ä½œä½¿ç”¨ POST æ–¹æ³•ï¼Œé¿å… URL åƒæ•¸æ´©æ¼æ•æ„Ÿè³‡è¨Š
2. **çµ±ä¸€å›æ‡‰æ ¼å¼**: `{ success: true, items: [...], pagination: {...} }`
3. **åˆ†é æ©Ÿåˆ¶**: page/limit åˆ†é å–ä»£ skip/limitï¼Œå‰ç«¯å‹å–„
4. **æœå‹™å±¤åˆ†é›¢**: API â†’ Service â†’ Repository ä¸‰å±¤æ¶æ§‹

### å¾Œç«¯ API ç«¯é»è¦ç¯„ (Backend)

| è³‡æº | åˆ—è¡¨ | è©³æƒ… | å»ºç«‹ | æ›´æ–° | åˆªé™¤ |
|------|------|------|------|------|------|
| agencies | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |
| documents | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |
| vendors | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |
| projects | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |
| users | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |

### å‰ç«¯ API æ¨¡çµ„ (Frontend)

```
frontend/src/api/
â”œâ”€â”€ client.ts          # çµ±ä¸€ API Client (ApiClient class)
â”œâ”€â”€ types.ts           # å…±ç”¨å‹åˆ¥å®šç¾© (PaginatedResponse, ErrorResponse)
â”œâ”€â”€ agenciesApi.ts     # æ©Ÿé—œ API æœå‹™ âœ…
â”œâ”€â”€ documentsApi.ts    # å…¬æ–‡ API æœå‹™ âœ…
â”œâ”€â”€ projectsApi.ts     # å°ˆæ¡ˆ API æœå‹™ âœ…
â”œâ”€â”€ usersApi.ts        # ä½¿ç”¨è€… API æœå‹™ âœ…
â”œâ”€â”€ vendors.ts         # å» å•† API æœå‹™ âœ…
â”œâ”€â”€ index.ts           # çµ±ä¸€åŒ¯å‡º
â”‚
â””â”€â”€ [deprecated]
    â”œâ”€â”€ config.ts      # èˆŠç‰ˆé…ç½® â†’ å·²æ£„ç”¨
    â”œâ”€â”€ documents.ts   # èˆŠç‰ˆå…¬æ–‡ API â†’ å·²æ£„ç”¨
    â””â”€â”€ projects.ts    # èˆŠç‰ˆå°ˆæ¡ˆ API â†’ å·²æ£„ç”¨
```

### çµ±ä¸€å›æ‡‰æ ¼å¼

```typescript
// åˆ—è¡¨å›æ‡‰
interface PaginatedResponse<T> {
  success: boolean;
  items: T[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    total_pages: number;
    has_next: boolean;
    has_prev: boolean;
  };
}

// éŒ¯èª¤å›æ‡‰
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: { field?: string; message: string }[];
  };
}
```

### ä½¿ç”¨ç¯„ä¾‹

```typescript
// å‰ç«¯å‘¼å«
import { agenciesApi } from '@/api';

const { items, pagination } = await agenciesApi.getAgencies({
  page: 1,
  limit: 20,
  search: 'é—œéµå­—',
});
```

---

## ğŸ“‹ ç›¸é—œæ–‡ä»¶åŠŸèƒ½è¨­è¨ˆ (Related Documents Design)

### ç¾æœ‰æ¶æ§‹
- **OfficialDocument æ¨¡å‹**: åŒ…å« `contract_project_id` å¤–éµæŒ‡å‘ ContractProject
- **ContractProject æ¨¡å‹**: åŒ…å« `documents` relationship (ä¸€å°å¤š)
- **å‰ç«¯ UI**: ContractCaseDetailPage TAB 4 "ç›¸é—œæ–‡ä»¶" å·²æœ‰é¡¯ç¤ºçµæ§‹

### è³‡æ–™åº«é—œè¯
```
ContractProject (contract_projects)
    â”‚
    â””â”€â”€ documents (OfficialDocument[])
          â”‚ contract_project_id (FK)
          â”‚
          â””â”€â”€ OfficialDocument (documents)
```

### éœ€å¯¦ä½œ API ç«¯é»

1. **GET `/api/projects/{project_id}/documents`**
   - åŠŸèƒ½: å–å¾—å°ˆæ¡ˆé—œè¯çš„å…¬æ–‡åˆ—è¡¨
   - å›æ‡‰: `{ documents: RelatedDocument[], total: number }`

2. **POST `/api/projects/{project_id}/documents/{document_id}`**
   - åŠŸèƒ½: å°‡å…¬æ–‡é—œè¯åˆ°å°ˆæ¡ˆ (è¨­å®š contract_project_id)
   - æ³¨æ„: ä¸€ä»½å…¬æ–‡åªèƒ½é—œè¯ä¸€å€‹å°ˆæ¡ˆ

3. **DELETE `/api/projects/{project_id}/documents/{document_id}`**
   - åŠŸèƒ½: è§£é™¤å…¬æ–‡èˆ‡å°ˆæ¡ˆçš„é—œè¯ (æ¸…é™¤ contract_project_id)

### å‰ç«¯æ•´åˆæ­¥é©Ÿ

1. **æ–°å¢ API æ–¹æ³•** (`frontend/src/api/projects.ts`):
```typescript
// å–å¾—å°ˆæ¡ˆé—œè¯æ–‡ä»¶
getProjectDocuments: async (projectId: number) => {
  const response = await api.get(`/projects/${projectId}/documents`);
  return response.data;
},

// é—œè¯æ–‡ä»¶åˆ°å°ˆæ¡ˆ
linkDocument: async (projectId: number, documentId: number) => {
  const response = await api.post(`/projects/${projectId}/documents/${documentId}`);
  return response.data;
},

// è§£é™¤æ–‡ä»¶é—œè¯
unlinkDocument: async (projectId: number, documentId: number) => {
  const response = await api.delete(`/projects/${projectId}/documents/${documentId}`);
  return response.data;
},
```

2. **æ›´æ–° loadData()** (`ContractCaseDetailPage.tsx`):
```typescript
const [projectResponse, staffResponse, vendorsResponse, documentsResponse] = await Promise.all([
  projectsApi.getProject(projectId),
  projectStaffApi.getProjectStaff(projectId).catch(...),
  projectVendorsApi.getProjectVendors(projectId).catch(...),
  projectsApi.getProjectDocuments(projectId).catch(() => ({ documents: [], total: 0 })),
]);
setRelatedDocs(documentsResponse.documents);
```

3. **æ–°å¢é—œè¯å°è©±æ¡†**: ä½¿ç”¨ Modal + å…¬æ–‡æœå°‹/é¸æ“‡åŠŸèƒ½

### é™„ä»¶åŠŸèƒ½è¨­è¨ˆ

- ç¾æœ‰ `DocumentAttachment` æ¨¡å‹å·²å­˜åœ¨
- éœ€è€ƒæ…®æ˜¯å¦æ–°å¢ `ProjectAttachment` æ¨¡å‹æˆ–ä½¿ç”¨ç¾æœ‰é™„ä»¶æ©Ÿåˆ¶
- å»ºè­°: ç›´æ¥ä½¿ç”¨å…¬æ–‡é™„ä»¶ï¼Œé€éå…¬æ–‡é—œè¯å°ˆæ¡ˆé–“æ¥é¡¯ç¤º

---

## ğŸ“ Notes
- **å‰ç«¯é–‹ç™¼ä¼ºæœå™¨**: http://localhost:3000
- **å¾Œç«¯ API æ–‡æª”**: http://localhost:8001/api/docs
- **ä¸»è¦ API ç«¯é»**: `/api/documents-enhanced`, `/api/projects`, `/api/vendors`, `/api/agencies`
- æ¯æ¬¡ä¿®æ”¹å¾Œç«¯ä»£ç¢¼éœ€é‡å•Ÿ Docker: `docker restart ck_missive_backend`

## ğŸ”— Reference
- è©³ç´° API æ–‡æª”: `docs/wiki/Backend-API-Overview.md`
- çµ„ä»¶æ–‡æª”: `docs/wiki/Frontend-Components.md`
- è³‡æ–™æ¨¡å‹: `docs/wiki/Database-Models.md`

---
*æœ€å¾Œæ›´æ–°: 2026-01-05 - API æ¶æ§‹é‡æ§‹å®Œæˆ (POST-only è³‡å®‰æ©Ÿåˆ¶ã€çµ±ä¸€å›æ‡‰æ ¼å¼ã€æœå‹™å±¤åˆ†é›¢)*
