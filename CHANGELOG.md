# 專案變更日誌 (Changelog)

本文檔記錄了自優化統整作業開始以來，對「乾坤測繪公文管理系統」進行的所有主要變更、修復與功能增強。

---

## 版本 3.0.0 (2025-09-18) - 架構優化與功能整合

這是一個重大的重構版本，旨在解決系統的歷史技術債，統一混亂的模組，並為未來的開發奠定穩固的基礎。

### 核心重構 (Core Refactoring)

- **✅ 統一後端行事曆模組**
  - **問題**: 系統中存在 `calendar.py`, `pure_calendar.py`, `document_calendar.py` 三個功能重疊的日曆模組，導致資料孤島與大量 Bug。
  - **優化**: 廢棄了 `calendar.py` 和 `pure_calendar.py`，將所有日曆事件的查詢、新增、修改邏輯全部集中到 `document_calendar.py` 中，並將 API 路由統一為 `/api/calendar`。

- **✅ 精簡與整合管理腳本**
  - **問題**: `backend/` 目錄下存在大量零散的管理腳本（如 `create_admin_user.py`, `check_db.py` 等），難以維護。
  - **優化**: 建立了一個統一的命令列管理工具 `backend/manage.py`，使用 `Typer` 函式庫，將所有管理功能整合為清晰的子命令（如 `python manage.py create-admin`），並刪除了所有舊的、多餘的腳本。

- **✅ 清理主程式 `main.py`**
  - **問題**: `main.py` 中包含了大量用於臨時修復問題的「緊急修復」API 端點，造成程式碼混亂。
  - **優化**: 移除了所有臨時的 API 端點，讓 `main.py` 只專注於應用程式的初始化、中介軟體設定和生命週期管理。

### 功能增強 (Feature Enhancements)

- **✅ 實現「智慧型」關聯機制**
  - **問題**: 「機關單位」和「承攬案件」與公文的關聯僅依賴純文字，容易出錯且難以分析。
  - **優化**: 在 `document_service.py` 中建立了「獲取或創建」(Get or Create) 的智慧型學習邏輯。現在新增或匯入公文時，系統會自動在 `government_agencies` 和 `contract_projects` 表中查找或建立對應記錄，並使用精準的 ID 進行外鍵關聯。

- **✅ 全面啟用事件提醒系統**
  - **問題**: 提醒功能 (`ReminderScheduler`) 已被開發但從未啟用。
  - **優化**: 修改了 `api/routes.py` 以啟用提醒管理的 API，並在 `main.py` 的應用程式啟動事件中，自動在背景啟動提醒排程器。

- **✅ 新增完整的管理 API**
  - **問題**: 前端頁面缺少修改和刪除現有資料（如機關單位、日曆事件）的能力。
  - **優化**: 為「機關單位」和「日曆事件」模組建立了完整的後端 `PUT` (更新) 和 `DELETE` (刪除) API 端點，為前端實現「彈出式編輯表單」提供了必要的後端支援。

### 錯誤修復 (Bug Fixes)

- **✅ 修復了日曆事件「載入失敗/不可見」問題**
  - **原因**: 綜合了 API 參數驗證失敗 (422 Error)、後端查詢時區不匹配 (500 Error)、使用者權限過濾過嚴等多重問題。
  - **修復**: 透過將 API 日期參數設為可選、統一後端日期時間的時區處理、放寬使用者查詢權限（建立者或指派者均可見），徹底解決了此頑固問題。

- **✅ 修復了「刪除公文」失敗問題**
  - **原因**: 刪除公文時，因存在關聯的日曆事件，觸發了資料庫的外鍵約束保護，導致操作失敗 (500 Error)。
  - **修復**: 修改了 `extended/models.py` 中的資料模型，為 `OfficialDocument` 與其子記錄（如日曆事件）的關聯關係，明確設定了「級聯刪除」(`cascade delete`)規則。

- **✅ 修復了「新增公文」失敗問題**
  - **原因**: 在新增公文後，自動同步日曆事件的流程中，因內部函式呼叫的參數不匹配導致後端崩潰 (500 Error)。
  - **修復**: 修正了 `DocumentCalendarIntegrator` 中不匹配的 API 呼叫參數，打通了從建立公文到同步日曆的完整流程。

### 文檔化 (Documentation)

- **✅ 建立 `README.md`**
  - 撰寫了一份全新的、完整的專案說明檔案，詳細介紹了專案技術棧、以及如何從零開始設定、安裝、執行和管理此優化後的系統。

- **✅ 建立 `CHANGELOG.md`**
  - 建立了此變更日誌檔案，用於追蹤專案的重大更新歷史。
