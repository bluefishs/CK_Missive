# =============================================================================
# CK_Missive - åŸºç¤è¨­æ–½å°ˆç”¨ Docker Compose
# =============================================================================
# ç›®æ¨™ï¼šåƒ…é‹è¡Œ PostgreSQL + Redisï¼Œæ­é… PM2 ç®¡ç†æ‡‰ç”¨æœå‹™ï¼ˆæ··åˆé–‹ç™¼æ¨¡å¼ï¼‰
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   å•Ÿå‹•åŸºç¤è¨­æ–½:  docker compose -f docker-compose.infra.yml up -d
#   åœæ­¢åŸºç¤è¨­æ–½:  docker compose -f docker-compose.infra.yml down
#   æŸ¥çœ‹ç‹€æ…‹:      docker compose -f docker-compose.infra.yml ps
#
# æ­é… PM2:
#   pm2 start ecosystem.config.js
#
# æˆ–ä½¿ç”¨çµ±ä¸€è…³æœ¬:
#   .\scripts\dev-start.ps1
#
# Version: 1.0.0
# Created: 2026-02-09
# =============================================================================

name: ${COMPOSE_PROJECT_NAME}_infra

services:
  # --- PostgreSQL è³‡æ–™åº«æœå‹™ ---
  postgres:
    image: pgvector/pgvector:0.8.0-pg15
    container_name: ${COMPOSE_PROJECT_NAME}_postgres_dev
    env_file: .env
    environment:
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    ports:
      - "${POSTGRES_HOST_PORT}:${POSTGRES_CONTAINER_PORT}"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./configs/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./configs/postgresql-tuning.conf:/etc/postgresql/tuning.conf:ro
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "work_mem=16MB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "effective_cache_size=1536MB"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "max_connections=50"
      - "-c"
      - "log_min_duration_statement=500"
      - "-c"
      - "log_lock_waits=on"
      - "-c"
      - "log_temp_files=0"
      - "-c"
      - "default_statistics_target=200"
      - "-c"
      - "timezone=Asia/Taipei"
    networks:
      - app_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Redis å¿«å–æœå‹™ ---
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME}_redis_dev
    ports:
      - "${REDIS_HOST_PORT}:${REDIS_CONTAINER_PORT}"
    volumes:
      - redis_dev_data:/data
    networks:
      - app_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # --- ğŸ¤– Ollama AI æœå‹™ (Embedding + Chat) ---
  # GPU åŠ é€Ÿï¼šéœ€è¦ NVIDIA GPU + nvidia-container-toolkit
  # ç„¡ GPU ç’°å¢ƒï¼šä½¿ç”¨ docker-compose.infra.cpu.yml override æˆ–ç§»é™¤ deploy.resources.reservations.devices
  ollama:
    image: ollama/ollama:latest
    container_name: ${COMPOSE_PROJECT_NAME}_ollama_dev
    ports:
      - "${OLLAMA_HOST_PORT:-11434}:11434"
    volumes:
      - ollama_dev_data:/root/.ollama
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
        limits:
          memory: 8G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# --- æŒä¹…åŒ–å„²å­˜ï¼ˆèˆ‡ docker-compose.dev.yml å…±äº«ï¼‰ ---
volumes:
  postgres_dev_data:
    name: ${COMPOSE_PROJECT_NAME}_postgres_dev_data
  redis_dev_data:
    name: ${COMPOSE_PROJECT_NAME}_redis_dev_data
  ollama_dev_data:
    name: ${COMPOSE_PROJECT_NAME}_ollama_dev_data

# --- ç¶²è·¯é…ç½®ï¼ˆèˆ‡ docker-compose.dev.yml å…±äº«ï¼‰ ---
networks:
  app_network:
    name: ck_missive_dev_network
    driver: bridge
