# =============================================================================
# CK_Missive - 基礎設施專用 Docker Compose
# =============================================================================
# 目標：僅運行 PostgreSQL + Redis，搭配 PM2 管理應用服務（混合開發模式）
#
# 使用方式：
#   啟動基礎設施:  docker compose -f docker-compose.infra.yml up -d
#   停止基礎設施:  docker compose -f docker-compose.infra.yml down
#   查看狀態:      docker compose -f docker-compose.infra.yml ps
#
# 搭配 PM2:
#   pm2 start ecosystem.config.js
#
# 或使用統一腳本:
#   .\scripts\dev-start.ps1
#
# Version: 1.0.0
# Created: 2026-02-09
# =============================================================================

name: ${COMPOSE_PROJECT_NAME}_infra

services:
  # --- PostgreSQL 資料庫服務 ---
  postgres:
    image: postgres:15-alpine
    container_name: ${COMPOSE_PROJECT_NAME}_postgres_dev
    env_file: .env
    environment:
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    ports:
      - "${POSTGRES_HOST_PORT}:${POSTGRES_CONTAINER_PORT}"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./configs/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./configs/postgresql-tuning.conf:/etc/postgresql/tuning.conf:ro
    command: postgres -c 'include=/etc/postgresql/tuning.conf'
    networks:
      - app_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --- Redis 快取服務 ---
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME}_redis_dev
    ports:
      - "${REDIS_HOST_PORT}:${REDIS_CONTAINER_PORT}"
    volumes:
      - redis_dev_data:/data
    networks:
      - app_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

# --- 持久化儲存（與 docker-compose.dev.yml 共享） ---
volumes:
  postgres_dev_data:
    name: ${COMPOSE_PROJECT_NAME}_postgres_dev_data
  redis_dev_data:
    name: ${COMPOSE_PROJECT_NAME}_redis_dev_data

# --- 網路配置（與 docker-compose.dev.yml 共享） ---
networks:
  app_network:
    name: ck_missive_dev_network
    driver: bridge
