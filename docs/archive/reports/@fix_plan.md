# CK_Missive Fix Plan

## ğŸ”´ High Priority (æ ¸å¿ƒåŠŸèƒ½)
- [x] å…¬æ–‡ç®¡ç†é é¢ - DocumentList æ’åºç¯©é¸åŠŸèƒ½ (Ant Design Table)
- [x] æ‰¿æ”¬æ¡ˆä»¶åˆ—è¡¨ - ContractCasePage é¡¯ç¤ºèˆ‡ CRUD åŠŸèƒ½
- [x] æ¡ˆä»¶è©³æƒ…é  - ContractCaseDetailPage å››å€‹ TAB åˆ†é æ•´åˆ (æ‰¿è¾¦åŒä»ã€å”åŠ›å» å•† CRUD)
- [x] å» å•†ç®¡ç† - VendorPage åˆ—è¡¨èˆ‡ç·¨è¼¯åŠŸèƒ½ (POST-only API)
- [x] æ©Ÿé—œå–®ä½ - AgenciesPage åˆ—è¡¨èˆ‡ç·¨è¼¯åŠŸèƒ½ (POST-only API)

## ğŸŸ¡ Medium Priority (é€²éšåŠŸèƒ½)
- [ ] è¡Œäº‹æ›†æ•´åˆ - CalendarPage èˆ‡å…¬æ–‡äº‹ä»¶é€£å‹•
- [ ] ç™¼æ–‡å­—è™Ÿç®¡ç† - DocumentNumbersPage è‡ªå‹•ç·¨è™Ÿ
- [ ] å…¬æ–‡åŒ¯å…¥/åŒ¯å‡º - DocumentImportPage, DocumentExportPage
- [ ] ä½¿ç”¨è€…æ¬Šé™ç®¡ç† - UserManagementPage, PermissionManagementPage
- [ ] Dashboard çµ±è¨ˆåœ–è¡¨å„ªåŒ–

## ğŸŸ¢ Low Priority (å„ªåŒ–é …ç›®)
- [ ] å‰ç«¯æ•ˆèƒ½å„ªåŒ– - æ¸›å°‘ API é‡è¤‡å‘¼å«
- [ ] éŒ¯èª¤è™•ç†å¼·åŒ– - çµ±ä¸€éŒ¯èª¤è¨Šæ¯æ ¼å¼
- [ ] TypeScript å‹åˆ¥å®Œå–„
- [ ] éŸ¿æ‡‰å¼è¨­è¨ˆèª¿æ•´
- [ ] å–®å…ƒæ¸¬è©¦è¦†è“‹

## âœ… Completed
- [x] Project initialization
- [x] Ralph å°ˆæ¡ˆåˆå§‹åŒ–
- [x] CodeWiki æ–‡æª”å»ºç«‹ (docs/wiki/)
- [x] Docker å®¹å™¨ç’°å¢ƒç¢ºèª
- [x] Dashboard API é©—è­‰ (502 å…¬æ–‡è³‡æ–™æ­£å¸¸)
- [x] DocumentActions çµ„ä»¶ä¿®å¾© (EyeOutlined éŒ¯èª¤)
- [x] API CORS è¨­å®šä¿®å¾©
- [x] project-vendors API 500 éŒ¯èª¤ä¿®å¾©
- [x] DocumentList æ¬„ä½æ’åºèˆ‡ç¯©é¸æ©Ÿåˆ¶ (Ant Design Table)
- [x] API å›æ‡‰æ ¼å¼è½‰æ›ä¿®å¾© (documents.ts)
- [x] DocumentList æ¬„å¯¬æœ€é©æ¯”ä¾‹å„ªåŒ– + Tooltip
- [x] ContractCasePage æ¡ˆä»¶æ€§è³ª (category) æ¨™ç±¤é¡¯ç¤ºå°æ‡‰ (01â†’01å§”è¾¦æ¡ˆä»¶ç­‰)
- [x] Vendors API èªè­‰å•é¡Œä¿®å¾© (ç§»é™¤ GET list èªè­‰éœ€æ±‚)
- [x] ProjectStaff è§’è‰²é©—è­‰ä¿®å¾© (æ“´å±• role validator æ”¯æ´å‰ç«¯é¸é …)
- [x] 422 Pydantic éŒ¯èª¤è™•ç†ä¿®å¾© (ContractCaseDetailPage éŒ¯èª¤è¨Šæ¯è§£æ)
- [x] å”åŠ›å» å•†æ¥­å‹™é¡åˆ¥æ›´æ–° (æ¸¬é‡æ¥­å‹™ã€ç³»çµ±æ¥­å‹™ã€æŸ¥ä¼°æ¥­å‹™ã€å…¶ä»–é¡åˆ¥)
- [x] å» å•†ç®¡ç†ç‡Ÿæ¥­é …ç›®æ¬„ä½ CRUD å°æ‡‰å®Œæˆ (VendorList + schema validation)
- [x] æ‰¿è¾¦åŒä»å°ˆæ¡ˆè§’è‰²æ›´æ–° (è¨ˆç•«ä¸»æŒã€è¨ˆç•«å”åŒã€å°ˆæ¡ˆPMã€è·å®‰ä¸»ç®¡)
- [x] StaffPage èˆ‡ ContractCaseDetailPage è§’è‰²é¸é …åŒæ­¥
- [x] StaffPage CRUD åŠŸèƒ½ä¿®å¾© (users.py å®Œæ•´ CRUD + schema å°æ‡‰)
- [x] å…¬æ–‡ç®¡ç†é é¢å„ªåŒ– - åˆªé™¤é‡è¤‡å„€è¡¨æ¿ã€ä¿®æ­£æ”¶ç™¼æ–‡çµ±è¨ˆã€ç¯©é¸å€æ”¶é—”
- [x] API trailing slash ä¿®å¾© - vendors.py, users.py, project_staff.py, project_vendors.py è·¯ç”±è·¯å¾‘æ”¹ç‚ºç©ºå­—ä¸²é¿å… 307/404
- [x] ContractCaseDetailPage TAB CRUD åŠŸèƒ½æ¢å¾©æ­£å¸¸ (æ‰¿è¾¦åŒä»ã€å”åŠ›å» å•†é¸å–®è¼‰å…¥)
- [x] **API æ¶æ§‹é‡æ§‹ (POST-only è³‡å®‰æ©Ÿåˆ¶)** - çµ±ä¸€å›æ‡‰æ ¼å¼èˆ‡æœå‹™å±¤æ©Ÿåˆ¶

### ğŸ†• 2026-01-05 æ–°å¢å®Œæˆé …ç›®
- [x] **æµæ°´åºè™Ÿ (auto_serial) æ ¼å¼ä¿®å¾©** - é‡è¨­ç‚º R0001~R0334, S0001~S0169
- [x] **ORM æ¨¡å‹æ¬„ä½è£œé½Š** - OfficialDocument æ–°å¢ auto_serial Column
- [x] **Schema å‹åˆ¥ä¿®æ­£** - auto_serial: Optional[int] â†’ Optional[str]
- [x] **æ”¶ç™¼å–®ä½é¡¯ç¤ºå„ªåŒ–** - extractAgencyName() æå–æ©Ÿé—œåç¨± (ç„¡ä»£ç¢¼)
- [x] **å…¬æ–‡-å°ˆæ¡ˆé—œè¯** - æ™ºèƒ½æ¯”å°é—œè¯ 211 ç­†å…¬æ–‡åˆ°æ‰¿æ”¬æ¡ˆä»¶
- [x] **API å›æ‡‰æ“´å……** - contract_project_name, assigned_staff æ¬„ä½
- [x] **å‰ç«¯æ¬„ä½æ–°å¢** - æ‰¿æ”¬æ¡ˆä»¶ã€æ¥­å‹™åŒä»æ¬„ä½é¡¯ç¤º
- [x] **ç¯©é¸åŠŸèƒ½ä¿®å¾©** - category TAB ç¯©é¸æ­£ç¢ºå‚³éå¾Œç«¯

### ğŸ†• 2026-01-06 æ–°å¢å®Œæˆé …ç›®
- [x] **TypeScript ç·¨è­¯éŒ¯èª¤ä¿®å¾©** - DocumentList, DocumentFilter, UnifiedTable ç­‰çµ„ä»¶
- [x] **è³‡æ–™å°æ‡‰éŒ¯èª¤ä¿®æ­£** - ä¿®å¾© id=1, id=222 å…¬æ–‡ä¸»æ—¨å°æ‡‰å•é¡Œ
- [x] **CSV åŒ¯å…¥é©—è­‰å¼·åŒ–** - csv_processor.py æ–°å¢æ ¼å¼é©—è­‰ã€æ¸¬è©¦è³‡æ–™éæ¿¾
- [x] **è³‡æ–™åº«æ¯æ—¥å‚™ä»½æ©Ÿåˆ¶** - PowerShell/Bash è‡ªå‹•å‚™ä»½è…³æœ¬ + æ’ç¨‹è¨­å®š

---

## ğŸ—ï¸ API Architecture (POST-only è³‡å®‰æ©Ÿåˆ¶)

### è¨­è¨ˆåŸå‰‡
1. **POST-only ç«¯é»**: æ‰€æœ‰è³‡æ–™æ“ä½œä½¿ç”¨ POST æ–¹æ³•ï¼Œé¿å… URL åƒæ•¸æ´©æ¼æ•æ„Ÿè³‡è¨Š
2. **çµ±ä¸€å›æ‡‰æ ¼å¼**: `{ success: true, items: [...], pagination: {...} }`
3. **åˆ†é æ©Ÿåˆ¶**: page/limit åˆ†é å–ä»£ skip/limitï¼Œå‰ç«¯å‹å–„
4. **æœå‹™å±¤åˆ†é›¢**: API â†’ Service â†’ Repository ä¸‰å±¤æ¶æ§‹

### å¾Œç«¯ API ç«¯é»è¦ç¯„ (Backend)

| è³‡æº | åˆ—è¡¨ | è©³æƒ… | å»ºç«‹ | æ›´æ–° | åˆªé™¤ |
|------|------|------|------|------|------|
| agencies | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |
| documents | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |
| vendors | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |
| projects | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |
| users | POST `/list` | POST `/{id}/detail` | POST `` | POST `/{id}/update` | POST `/{id}/delete` |

### å‰ç«¯ API æ¨¡çµ„ (Frontend)

```
frontend/src/api/
â”œâ”€â”€ client.ts          # çµ±ä¸€ API Client (ApiClient class)
â”œâ”€â”€ types.ts           # å…±ç”¨å‹åˆ¥å®šç¾© (PaginatedResponse, ErrorResponse)
â”œâ”€â”€ agenciesApi.ts     # æ©Ÿé—œ API æœå‹™ âœ…
â”œâ”€â”€ documentsApi.ts    # å…¬æ–‡ API æœå‹™ âœ…
â”œâ”€â”€ projectsApi.ts     # å°ˆæ¡ˆ API æœå‹™ âœ…
â”œâ”€â”€ usersApi.ts        # ä½¿ç”¨è€… API æœå‹™ âœ…
â”œâ”€â”€ vendors.ts         # å» å•† API æœå‹™ âœ…
â”œâ”€â”€ index.ts           # çµ±ä¸€åŒ¯å‡º
â”‚
â””â”€â”€ [deprecated]
    â”œâ”€â”€ config.ts      # èˆŠç‰ˆé…ç½® â†’ å·²æ£„ç”¨
    â”œâ”€â”€ documents.ts   # èˆŠç‰ˆå…¬æ–‡ API â†’ å·²æ£„ç”¨
    â””â”€â”€ projects.ts    # èˆŠç‰ˆå°ˆæ¡ˆ API â†’ å·²æ£„ç”¨
```

### çµ±ä¸€å›æ‡‰æ ¼å¼

```typescript
// åˆ—è¡¨å›æ‡‰
interface PaginatedResponse<T> {
  success: boolean;
  items: T[];
  pagination: {
    total: number;
    page: number;
    limit: number;
    total_pages: number;
    has_next: boolean;
    has_prev: boolean;
  };
}

// éŒ¯èª¤å›æ‡‰
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: { field?: string; message: string }[];
  };
}
```

### ä½¿ç”¨ç¯„ä¾‹

```typescript
// å‰ç«¯å‘¼å«
import { agenciesApi } from '@/api';

const { items, pagination } = await agenciesApi.getAgencies({
  page: 1,
  limit: 20,
  search: 'é—œéµå­—',
});
```

---

## ğŸ“‹ ç›¸é—œæ–‡ä»¶åŠŸèƒ½è¨­è¨ˆ (Related Documents Design)

### ç¾æœ‰æ¶æ§‹
- **OfficialDocument æ¨¡å‹**: åŒ…å« `contract_project_id` å¤–éµæŒ‡å‘ ContractProject
- **ContractProject æ¨¡å‹**: åŒ…å« `documents` relationship (ä¸€å°å¤š)
- **å‰ç«¯ UI**: ContractCaseDetailPage TAB 4 "ç›¸é—œæ–‡ä»¶" å·²æœ‰é¡¯ç¤ºçµæ§‹

### è³‡æ–™åº«é—œè¯
```
ContractProject (contract_projects)
    â”‚
    â””â”€â”€ documents (OfficialDocument[])
          â”‚ contract_project_id (FK)
          â”‚
          â””â”€â”€ OfficialDocument (documents)
```

### éœ€å¯¦ä½œ API ç«¯é»

1. **GET `/api/projects/{project_id}/documents`**
   - åŠŸèƒ½: å–å¾—å°ˆæ¡ˆé—œè¯çš„å…¬æ–‡åˆ—è¡¨
   - å›æ‡‰: `{ documents: RelatedDocument[], total: number }`

2. **POST `/api/projects/{project_id}/documents/{document_id}`**
   - åŠŸèƒ½: å°‡å…¬æ–‡é—œè¯åˆ°å°ˆæ¡ˆ (è¨­å®š contract_project_id)
   - æ³¨æ„: ä¸€ä»½å…¬æ–‡åªèƒ½é—œè¯ä¸€å€‹å°ˆæ¡ˆ

3. **DELETE `/api/projects/{project_id}/documents/{document_id}`**
   - åŠŸèƒ½: è§£é™¤å…¬æ–‡èˆ‡å°ˆæ¡ˆçš„é—œè¯ (æ¸…é™¤ contract_project_id)

### å‰ç«¯æ•´åˆæ­¥é©Ÿ

1. **æ–°å¢ API æ–¹æ³•** (`frontend/src/api/projects.ts`):
```typescript
// å–å¾—å°ˆæ¡ˆé—œè¯æ–‡ä»¶
getProjectDocuments: async (projectId: number) => {
  const response = await api.get(`/projects/${projectId}/documents`);
  return response.data;
},

// é—œè¯æ–‡ä»¶åˆ°å°ˆæ¡ˆ
linkDocument: async (projectId: number, documentId: number) => {
  const response = await api.post(`/projects/${projectId}/documents/${documentId}`);
  return response.data;
},

// è§£é™¤æ–‡ä»¶é—œè¯
unlinkDocument: async (projectId: number, documentId: number) => {
  const response = await api.delete(`/projects/${projectId}/documents/${documentId}`);
  return response.data;
},
```

2. **æ›´æ–° loadData()** (`ContractCaseDetailPage.tsx`):
```typescript
const [projectResponse, staffResponse, vendorsResponse, documentsResponse] = await Promise.all([
  projectsApi.getProject(projectId),
  projectStaffApi.getProjectStaff(projectId).catch(...),
  projectVendorsApi.getProjectVendors(projectId).catch(...),
  projectsApi.getProjectDocuments(projectId).catch(() => ({ documents: [], total: 0 })),
]);
setRelatedDocs(documentsResponse.documents);
```

3. **æ–°å¢é—œè¯å°è©±æ¡†**: ä½¿ç”¨ Modal + å…¬æ–‡æœå°‹/é¸æ“‡åŠŸèƒ½

### é™„ä»¶åŠŸèƒ½è¨­è¨ˆ

- ç¾æœ‰ `DocumentAttachment` æ¨¡å‹å·²å­˜åœ¨
- éœ€è€ƒæ…®æ˜¯å¦æ–°å¢ `ProjectAttachment` æ¨¡å‹æˆ–ä½¿ç”¨ç¾æœ‰é™„ä»¶æ©Ÿåˆ¶
- å»ºè­°: ç›´æ¥ä½¿ç”¨å…¬æ–‡é™„ä»¶ï¼Œé€éå…¬æ–‡é—œè¯å°ˆæ¡ˆé–“æ¥é¡¯ç¤º

---

## ğŸ“ Notes
- **å‰ç«¯é–‹ç™¼ä¼ºæœå™¨**: http://localhost:3000
- **å¾Œç«¯ API æ–‡æª”**: http://localhost:8001/api/docs
- **ä¸»è¦ API ç«¯é»**: `/api/documents-enhanced`, `/api/projects`, `/api/vendors`, `/api/agencies`
- æ¯æ¬¡ä¿®æ”¹å¾Œç«¯ä»£ç¢¼éœ€é‡å•Ÿ Docker: `docker restart ck_missive_backend`

## ğŸ”— Reference
- è©³ç´° API æ–‡æª”: `docs/wiki/Backend-API-Overview.md`
- çµ„ä»¶æ–‡æª”: `docs/wiki/Frontend-Components.md`
- è³‡æ–™æ¨¡å‹: `docs/wiki/Database-Models.md`

---

## ğŸ›ï¸ æ¶æ§‹å„ªåŒ–å»ºè­° (Architecture Optimization)

### 1. API å›æ‡‰æ ¼å¼çµ±ä¸€åŒ–

**ç¾æ³å•é¡Œ**:
- ä¸åŒ API ä½¿ç”¨ä¸åŒå›æ‡‰æ ¼å¼ (`items/documents`, `total/count`, `page/current`)
- å‰ç«¯éœ€é‡å°æ¯å€‹ API å¯«ä¸åŒçš„è½‰æ›é‚è¼¯

**å»ºè­°æ–¹æ¡ˆ**:
```python
# çµ±ä¸€åˆ†é å›æ‡‰æ ¼å¼
class UnifiedPaginatedResponse(BaseModel):
    success: bool = True
    items: List[Any]
    pagination: PaginationMeta

class PaginationMeta(BaseModel):
    total: int
    page: int
    limit: int
    total_pages: int
    has_next: bool
    has_prev: bool
```

### 2. é—œè¯æŸ¥è©¢æ•ˆèƒ½å„ªåŒ–

**ç¾æ³å•é¡Œ**:
- å…¬æ–‡åˆ—è¡¨éœ€é¡å¤–æŸ¥è©¢ contract_projects + project_user_assignments
- å¯èƒ½ç”¢ç”Ÿ N+1 æŸ¥è©¢å•é¡Œ

**å»ºè­°æ–¹æ¡ˆ**:
```python
# Option A: SQLAlchemy joined load
query = select(OfficialDocument).options(
    joinedload(OfficialDocument.contract_project).joinedload(ContractProject.staff)
)

# Option B: æ‰¹æ¬¡æŸ¥è©¢ (å·²å¯¦ä½œ)
project_ids = [doc.contract_project_id for doc in items]
projects = await db.execute(select(...).where(ContractProject.id.in_(project_ids)))

# Option C: è³‡æ–™åº« VIEW
CREATE VIEW document_with_project AS
SELECT d.*, cp.project_name, ...
FROM documents d
LEFT JOIN contract_projects cp ON d.contract_project_id = cp.id;
```

### 3. å¿«å–ç­–ç•¥å»ºè­°

**é©åˆå¿«å–çš„è³‡æ–™**:
| è³‡æ–™é¡å‹ | TTL | å¿«å–å±¤ |
|---------|-----|--------|
| æ©Ÿé—œä¸‹æ‹‰é¸å–® | 10 min | Redis |
| å» å•†ä¸‹æ‹‰é¸å–® | 10 min | Redis |
| æ‰¿æ”¬æ¡ˆä»¶ä¸‹æ‹‰ | 5 min | Redis |
| å¹´åº¦é¸å–® | 1 day | Redis |
| å…¬æ–‡åˆ—è¡¨ | 30 sec | React Query |

**å¯¦ä½œå»ºè­°**:
```python
# Backend Redis å¿«å–
from redis import asyncio as aioredis

@router.get("/agencies-dropdown")
async def get_agencies_dropdown(redis: aioredis.Redis = Depends(get_redis)):
    cached = await redis.get("agencies_dropdown")
    if cached:
        return json.loads(cached)
    data = await query_agencies()
    await redis.set("agencies_dropdown", json.dumps(data), ex=600)
    return data
```

```typescript
// Frontend React Query
const { data } = useQuery({
  queryKey: ['agencies'],
  queryFn: fetchAgencies,
  staleTime: 10 * 60 * 1000, // 10 minutes
});
```

### 4. éŒ¯èª¤è™•ç†çµ±ä¸€åŒ–

**å»ºè­°æ ¼å¼**:
```python
class ApiError(BaseModel):
    code: str           # éŒ¯èª¤ä»£ç¢¼ (ERR_NOT_FOUND, ERR_VALIDATION)
    message: str        # ä½¿ç”¨è€…å¯è®€è¨Šæ¯
    details: List[Dict] # è©³ç´°è³‡è¨Š (æ¬„ä½éŒ¯èª¤ç­‰)

# ç¯„ä¾‹
{
    "success": false,
    "error": {
        "code": "ERR_VALIDATION",
        "message": "è³‡æ–™é©—è­‰å¤±æ•—",
        "details": [
            {"field": "doc_number", "message": "å…¬æ–‡æ–‡è™Ÿä¸å¯ç‚ºç©º"}
        ]
    }
}
```

### 5. å‰ç«¯å‹åˆ¥å®‰å…¨å¼·åŒ–

**å»ºè­°**:
- ä½¿ç”¨ Zod é€²è¡ŒåŸ·è¡ŒæœŸé©—è­‰
- API Client è‡ªå‹•ç”¢ç”Ÿ TypeScript å‹åˆ¥

```typescript
// ä½¿ç”¨ zodios æˆ– orval è‡ªå‹•ç”¢ç”Ÿ
import { createApiClient } from './generated/api';

const api = createApiClient({
  baseUrl: 'http://localhost:8001/api'
});

// å‹åˆ¥å®‰å…¨çš„ API å‘¼å«
const { items } = await api.documents.list({ page: 1, limit: 10 });
```

### 6. è³‡æ–™åº«ç´¢å¼•å„ªåŒ–å»ºè­°

```sql
-- å»ºè­°æ–°å¢ç´¢å¼•
CREATE INDEX idx_documents_category ON documents(category);
CREATE INDEX idx_documents_contract_project ON documents(contract_project_id);
CREATE INDEX idx_documents_auto_serial ON documents(auto_serial);
CREATE INDEX idx_documents_doc_date ON documents(doc_date);

-- è¤‡åˆç´¢å¼• (å¸¸ç”¨æŸ¥è©¢)
CREATE INDEX idx_documents_category_date ON documents(category, doc_date DESC);
```

### 7. æ¸¬è©¦è¦†è“‹å»ºè­°

| æ¸¬è©¦é¡å‹ | å·¥å…· | å„ªå…ˆç´š |
|---------|------|--------|
| å–®å…ƒæ¸¬è©¦ (å¾Œç«¯) | pytest | ğŸ”´ é«˜ |
| å–®å…ƒæ¸¬è©¦ (å‰ç«¯) | Vitest | ğŸŸ¡ ä¸­ |
| API æ•´åˆæ¸¬è©¦ | pytest + httpx | ğŸ”´ é«˜ |
| E2E æ¸¬è©¦ | Playwright | ğŸŸ¢ ä½ |

---

---

## ğŸ›¡ï¸ è³‡æ–™å“è³ªç®¡ç†æ©Ÿåˆ¶ (Data Quality Management)

### 1. CSV åŒ¯å…¥é©—è­‰è¦å‰‡

**é©—è­‰å±¤ç´š** (`backend/app/services/csv_processor.py`):

| è¦å‰‡ | èªªæ˜ | è™•ç†æ–¹å¼ |
|------|------|----------|
| å…¬æ–‡å­—è™Ÿæ ¼å¼ | å¿…é ˆåŒ…å«ã€Œå­—ç¬¬ã€ä¸”å‰æœ‰æ©Ÿé—œå­—é¦– | è·³éè©²ç­† |
| ä¸»æ—¨å…§å®¹æª¢æŸ¥ | ä¸å¯ç‚ºç©ºã€testã€testingã€æ¸¬è©¦ | è·³éè©²ç­† |
| ä¸»æ—¨é•·åº¦è­¦å‘Š | å°‘æ–¼ 5 å­—å…ƒ | è¨˜éŒ„è­¦å‘Š |
| å¿…è¦æ¬„ä½ | doc_number ç‚ºå¿…å¡« | è·³éè©²ç­† |

**é©—è­‰ç¨‹å¼ç¢¼ç¤ºä¾‹**:
```python
# å…¬æ–‡å­—è™Ÿæ ¼å¼é©—è­‰
if 'å­—ç¬¬' in doc_number:
    prefix = doc_number.split('å­—ç¬¬')[0]
    if not prefix or len(prefix) < 2:
        logger.warning(f"[è³‡æ–™å“è³ª] å…¬æ–‡å­—è™Ÿæ ¼å¼ä¸å®Œæ•´: {doc_number}")
        return None

# æ¸¬è©¦è³‡æ–™éæ¿¾
if subject.lower() in ['test', 'testing', 'æ¸¬è©¦', '']:
    logger.warning(f"[è³‡æ–™å“è³ª] ä¸»æ—¨ç‚ºæ¸¬è©¦è³‡æ–™æˆ–ç©ºç™½ï¼Œè·³éæ­¤ç­†")
    return None
```

### 2. è³‡æ–™åº«å‚™ä»½æ©Ÿåˆ¶

**å‚™ä»½è…³æœ¬** (`scripts/backup/`):

| æª”æ¡ˆ | åŠŸèƒ½ |
|------|------|
| `db_backup.ps1` | Windows PowerShell å‚™ä»½è…³æœ¬ |
| `db_backup.sh` | Linux/Git Bash å‚™ä»½è…³æœ¬ |
| `db_restore.ps1` | è³‡æ–™åº«é‚„åŸè…³æœ¬ |
| `setup_scheduled_task.ps1` | Windows æ’ç¨‹è¨­å®š |

**å‚™ä»½ç­–ç•¥**:
- æ™‚é–“: æ¯æ—¥ 02:00
- ä¿ç•™: 7 å¤© (å¯èª¿æ•´)
- ä½ç½®: `backups/database/`
- æ ¼å¼: `ck_missive_backup_YYYYMMDD_HHMMSS.sql`

**å¿«é€ŸæŒ‡ä»¤**:
```powershell
# æ‰‹å‹•å‚™ä»½
.\scripts\backup\db_backup.ps1 -Verbose

# æŸ¥çœ‹å¯ç”¨å‚™ä»½
.\scripts\backup\db_restore.ps1 -List

# é‚„åŸæœ€æ–°å‚™ä»½
.\scripts\backup\db_restore.ps1 -Latest

# è¨­å®šæ¯æ—¥è‡ªå‹•å‚™ä»½ (éœ€ç®¡ç†å“¡)
.\scripts\backup\setup_scheduled_task.ps1 -BackupTime "02:00"
```

### 3. è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥

**å®šæœŸæª¢æŸ¥é …ç›®**:
- [ ] å…¬æ–‡å­—è™Ÿæ ¼å¼ä¸€è‡´æ€§
- [ ] ä¸»æ—¨å…§å®¹éç©ºå€¼
- [ ] æ”¶ç™¼å–®ä½å°æ‡‰æ­£ç¢º
- [ ] å°ˆæ¡ˆé—œè¯æœ‰æ•ˆæ€§

**SQL æª¢æŸ¥ç¯„ä¾‹**:
```sql
-- æª¢æŸ¥ç©ºä¸»æ—¨
SELECT id, doc_number FROM documents WHERE subject IS NULL OR subject = '';

-- æª¢æŸ¥æ ¼å¼ç•°å¸¸çš„å…¬æ–‡å­—è™Ÿ
SELECT id, doc_number FROM documents WHERE doc_number NOT LIKE '%å­—ç¬¬%';

-- æª¢æŸ¥å­¤ç«‹çš„å°ˆæ¡ˆé—œè¯
SELECT id, contract_project_id FROM documents
WHERE contract_project_id IS NOT NULL
AND contract_project_id NOT IN (SELECT id FROM contract_projects);
```

---

*æœ€å¾Œæ›´æ–°: 2026-01-06 - æ–°å¢è³‡æ–™å“è³ªç®¡ç†æ©Ÿåˆ¶èˆ‡å‚™ä»½ç­–ç•¥*
