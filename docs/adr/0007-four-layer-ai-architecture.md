# ADR-0007: AI 四層搜尋架構 — 規則引擎→向量匹配→LLM→合併

> **狀態**: accepted
> **日期**: 2026-02-26
> **決策者**: 開發團隊
> **關聯**: CHANGELOG v1.66.0, .claude/skills/ai-development.md

## 背景

CK_Missive 的自然語言搜尋需要處理多種截然不同的查詢類型：

1. **精確匹配** — 使用者輸入公文字號（如「桃建施字第 1130012345 號」），需要直接比對
2. **實體查詢** — 搜尋機關名稱（如「環保局」）需要匹配同義詞（「環境保護局」）
3. **語意查詢** — 「上個月關於道路施工的公文」需要理解時間範圍與主題
4. **複合篩選** — 「桃園市政府發來的收文，狀態為辦理中」需要解析多個篩選條件

單一搜尋策略無法同時滿足所有場景：關鍵字搜尋處理不了語意，LLM 對精確匹配太慢且可能幻覺，向量搜尋無法解析結構化篩選條件。系統需要一個分層架構，讓每種查詢類型由最適合的引擎處理。

## 決策

在 `SearchIntentParser` 中實作**四層級聯搜尋架構**：

### 第一層：規則引擎（同步，零延遲）
- 正則表達式匹配公文字號、日期範圍、狀態碼等結構化資訊
- 處理超過 50% 的查詢，無需呼叫任何外部服務
- 最高精確度，零延遲

### 第二層：向量匹配（非同步，亞秒級）
- pgvector cosine similarity 比對實體名稱與同義詞
- `synonym_expander.py` 搭配 53 組同義詞字典 + jieba 中文分詞
- 搜尋意圖實體擴展（`search_entity_expander.py`）

### 第三層：LLM 意圖解析（非同步，1-3 秒）
- Groq/Ollama 處理複雜自然語言查詢
- `response_format={"type": "json_object"}` 保證結構化 JSON 輸出
- Few-shot 範例引導（5 個範例，含 2 個派工單場景）
- 僅在前兩層無法處理時觸發，避免不必要的延遲

### 第四層：合併層
- 整合三層結果，解決衝突（如規則引擎與 LLM 解析結果不一致）
- 計算信心度分數（三級色彩顯示：高/中/低）
- 輸出統一的 `IntentParsedResult` 結構

## 後果

### 正面

- 規則引擎處理 50%+ 查詢零延遲，使用者體驗極佳
- 向量層自動捕捉同義詞匹配（如「環保局」→「環境保護局」），提升召回率
- LLM 層處理長尾複雜查詢，覆蓋邊界案例
- 分層信心度評分讓使用者知道搜尋結果的可靠程度
- 每一層獨立可測試、獨立可關閉，便於除錯與維護
- Agent Orchestrator 可複用 SearchIntentParser 的解析結果作為 hints

### 負面

- 四層架構意味著四條程式碼路徑需要維護，整體複雜度較高
- 合併層的衝突解決邏輯較複雜，需要處理多種邊界情況
- 規則引擎的正則表達式需要手動更新，無法自動適應新格式
- 當 LLM 層被觸發時，整體延遲增加 1-3 秒
- 四層之間的執行順序與短路邏輯需要仔細設計，避免不必要的運算

## 替代方案

| 方案 | 評估結果 |
|------|----------|
| **純 LLM 路由** | 架構最簡單，但所有查詢都需等待 1-3 秒，且對精確匹配場景可能產生幻覺 |
| **純關鍵字搜尋** | 延遲最低，但無法處理語意查詢，召回率低 |
| **純向量搜尋** | 語意能力佳，但無法解析結構化篩選條件（日期範圍、狀態碼） |
| **兩層（規則 + LLM）** | 較簡單，但缺少向量層的同義詞匹配能力，中間地帶的查詢品質不足 |

最終選擇四層架構，讓每種查詢類型由最適合的引擎處理，在延遲與品質之間取得最佳平衡。
