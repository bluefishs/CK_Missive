# ADR-0003: 內網 IP 自動免認證策略

> **狀態**: accepted
> **日期**: 2026-01-10
> **決策者**: 開發團隊
> **關聯**: CHANGELOG v1.3.0, `.claude/rules/auth-environment.md`

## 背景

CK_Missive 系統同時在多種網路環境下運作：

- **辦公室內網** — 日常使用，使用者希望無需登入即可直接操作
- **外部網路**（ngrok / 公開部署） — 需要 Google OAuth 認證保護

內網使用者（特別是非技術人員）對每次登入感到不便，且辦公室內部已有實體安全管控（門禁、網路隔離）。然而，認證邏輯若分散在各元件中，容易產生不一致的判斷結果與維護困難。

## 決策

實作**集中式四環境自動偵測**，根據 hostname / IP 自動決定認證策略：

| 環境類型 | 判斷條件 | 認證要求 |
|----------|----------|----------|
| `localhost` | hostname = localhost / 127.0.0.1 | Google OAuth |
| `internal` | 內網 IP（10.x / 172.16-31.x / 192.168.x） | **免認證** |
| `ngrok` | *.ngrok.io / *.ngrok-free.app | Google OAuth |
| `public` | 其他所有情況 | Google OAuth |

### 技術實作

- **前端**：所有環境偵測邏輯集中於 `frontend/src/config/env.ts`
  - `detectEnvironment()` — 回傳環境類型
  - `isInternalIP()` — 判斷是否為內網 IP
  - `isAuthDisabled()` — 根據環境自動判斷是否停用認證
- **後端**：中介軟體根據請求來源 IP 判斷，內網 IP 自動注入匿名使用者
- **禁止**在 `config/env.ts` 以外的地方自行定義環境偵測邏輯

### 內網 IP 範圍

```typescript
const internalIPPatterns = [
  /^10\./,                            // 10.0.0.0/8 (Class A)
  /^172\.(1[6-9]|2[0-9]|3[0-1])\./,  // 172.16.0.0/12 (Class B)
  /^192\.168\./                       // 192.168.0.0/16 (Class C)
];
```

## 後果

### 正面

- 內網使用者零摩擦存取，無需任何登入動作，大幅提升使用體驗
- 集中式偵測函數（`config/env.ts`）避免偵測邏輯重複，確保一致性
- 四種環境類型定義清晰，新增環境只需修改一處
- 開發環境（localhost）仍需認證，確保開發階段測試認證流程

### 負面

- 內網環境下所有使用者擁有完全存取權限，無法做到使用者層級的權限控管
- 若內網 IP 偵測失敗（如透過反向代理導致 IP 異常），使用者會遭遇非預期的認證要求
- 內網免認證意味著無法追蹤個別使用者的操作記錄（審計日誌僅能記錄匿名操作）

## 替代方案

| 方案 | 評估結果 |
|------|----------|
| **VPN 接入** | 安全性高，但增加使用者設定負擔，且需要 VPN 基礎設施 |
| **憑證式認證（PKI）** | 企業級安全，但需要建立完整的憑證管理基礎設施，對小型專案過於複雜 |
| **統一要求登入** | 最安全，但嚴重影響內網使用者的日常操作效率 |
| **IP 白名單 + 簡化登入** | 折衷方案，但仍需維護白名單，且增加設定複雜度 |

最終選擇 IP 自動偵測免認證，以內網實體安全為前提，優先考量使用者體驗。
