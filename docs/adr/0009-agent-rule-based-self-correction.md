# ADR-0009: Agent 規則式自動修正引擎（非 LLM 修正）

> **狀態**: accepted
> **日期**: 2026-02-26
> **決策者**: 開發團隊
> **關聯**: CHANGELOG v1.70.0

## 背景

Agent Orchestrator 使用 LLM（Groq/Ollama）進行查詢規劃，但本地模型 qwen3:4b 經常產生品質不佳的計劃——空的 `tool_calls`、錯誤的工具選擇、或遺漏派工單搜尋。若使用 LLM 重新規劃，不僅耗時（每次 3-5 秒），且可能重複相同錯誤，形成無效的重試迴圈。

系統需要一個快速、確定性的修正機制，在 LLM 規劃失敗時能立即補救，而非依賴另一次不可靠的 LLM 呼叫。

## 決策

在 `AgentOrchestrator._auto_correct()` 中實作 5 條規則式自動修正策略：

1. **空計劃恢復（Strategy 1）**：當 LLM 回傳無效 JSON 或空的 `tool_calls` 時，使用 `SearchIntentParser` 的 hints 建構後備計劃
2. **派工單號偵測（Strategy 2）**：正則表達式 `r"派工單[號]?\s*(\d{2,4})"` 提取派工單號碼，強制注入 `search_dispatch_orders` 工具呼叫
3. **零結果重試（Strategy 2.5）**：若 `search_documents` 回傳 0 筆結果且查詢包含派工關鍵字，自動追加 `search_dispatch_orders`
4. **實體鏈結擴展（Strategy 5）**：若 `search_entities` 有回傳結果，自動展開 `get_entity_detail` 取得完整資訊
5. **實體類型映射**：將 LLM 自然語言實體類型（如「機關」「廠商」）映射為資料庫縮寫格式

所有策略均為純規則邏輯，不涉及任何 LLM 呼叫。

## 後果

### 正面

- 修復 80% 以上的 qwen3:4b 規劃失敗，無需額外 LLM 呼叫
- 修正延遲低於 100ms（純字串比對與正則），相較 LLM 重試的 3-5 秒大幅改善
- 行為確定性：相同輸入永遠產生相同修正結果，便於測試與除錯
- 無額外 API 費用：不消耗 Groq 配額或 Ollama 運算資源
- 漸進式增強：新策略可獨立新增，不影響既有策略

### 負面

- 規則脆弱性：新的查詢模式需手動新增對應規則
- 正則表達式需持續維護：派工單號格式變更時需同步更新
- 修正策略可能掩蓋底層 LLM 品質問題，降低改善 LLM 的動力
- 規則數量增長後，策略間的交互作用可能產生非預期結果

## 替代方案

| 方案 | 評估 |
|------|------|
| LLM 自我反思迴圈 | 過慢（每次重試 3-5 秒），且可能重複相同錯誤 |
| 微調本地模型 | 缺乏足夠的訓練資料，且微調流程複雜 |
| 固定使用 Groq 規劃 | 喪失離線能力，且增加 API 成本與延遲 |
| 模板式查詢匹配 | 涵蓋範圍太窄，無法處理自然語言的多樣性 |
