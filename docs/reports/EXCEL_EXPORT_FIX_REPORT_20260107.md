# Excel 匯出功能修正報告

> 報告日期: 2026-01-07
> 版本: v1.0

---

## 一、本次修正的錯誤紀錄

### 1. API 端點錯誤 (HTTP 404)
| 項目 | 說明 |
|------|------|
| 問題 | 前端呼叫 `/documents/export/excel`，但後端只有 `/documents-enhanced/export` (CSV) |
| 原因 | Excel 匯出端點從未建立 |
| 修正 | 新增 `/documents-enhanced/export/excel` 端點 |
| 檔案 | `backend/app/api/endpoints/documents_enhanced.py` |

### 2. 中文檔名編碼錯誤
| 項目 | 說明 |
|------|------|
| 問題 | `'latin-1' codec can't encode characters` |
| 原因 | HTTP Header 不支援直接使用中文字元 |
| 修正 | 使用 `urllib.parse.quote()` 進行 URL 編碼 |
| 格式 | `filename*=UTF-8''%E4%B9%BE%E5%9D%A4...` (RFC 5987) |

### 3. 前端無法讀取檔名
| 項目 | 說明 |
|------|------|
| 問題 | 下載檔名仍為前端預設值，非後端指定 |
| 原因 1 | CORS 未暴露 `Content-Disposition` header |
| 原因 2 | 前端 regex 無法解析 RFC 5987 `filename*=UTF-8''...` 格式 |
| 修正 1 | `main.py` 添加 `expose_headers=["Content-Disposition"]` |
| 修正 2 | `exportUtils.ts` 添加 UTF-8 解碼邏輯 |

### 4. 只匯出 10 筆資料
| 項目 | 說明 |
|------|------|
| 問題 | 匯出只有當前頁面的 10 筆，非全部資料 |
| 原因 | 前端傳入 `document_ids` 限制了匯出範圍 |
| 修正 | 新增 `exportAll` 參數，預設 `true` 匯出全部 |

### 5. CSV 匯入欄位對應錯誤
| 項目 | 說明 |
|------|------|
| 問題 | 發文類別的 `send_date` 全部為空 |
| 原因 | `csv_processor.py` 將「發文日期」對應到 `doc_date` 而非 `send_date` |
| 修正 | 修改對應 `'發文日期': 'send_date'` |
| 資料修復 | 執行 SQL 將 173 筆發文的 `doc_date` 複製到 `send_date` |

---

## 二、資料品質問題

### 1. 公文類型 (doc_type) 錯誤值
```
目前分佈:
  函: 431 筆
  開會通知單: 57 筆
  會勘通知單: 14 筆
  收文: 4 筆 ← 錯誤（應為「類別」的值）
  發文: 4 筆 ← 錯誤（應為「類別」的值）
```

**建議**: 清理這 8 筆錯誤資料，將 `doc_type` 設為 NULL 或正確類型

### 2. 機關名稱含代碼
```
原始資料範例:
  - EB50819619 乾坤測繪科技有限公司
  - 376470600A (彰化縣和美地政事務所)
```

**處理方式**:
- 資料庫保留原始值（追溯用）
- 匯出時自動清理代碼

### 3. 承辦人欄位無資料
```sql
SELECT COUNT(*) FROM documents WHERE assignee IS NOT NULL AND LENGTH(assignee) > 0;
-- 結果: 0
```

**狀態**: 預留欄位，目前無使用

---

## 三、匯出格式調整紀錄

### 欄位變更對照表
| 序號 | 原欄位名稱 | 新欄位名稱 | 變更說明 |
|------|-----------|-----------|----------|
| 1 | - | 公文ID | 新增，對應附件資料夾 `doc_{id}` |
| 2 | 流水號 | 流水號 | 保留 |
| 3 | - | 發文形式 | 順序調整 |
| 4 | - | 類別 | 順序調整 |
| 5 | - | 公文類型 | 順序調整，過濾錯誤值 |
| 6 | 公文字號 | 公文字號 | 順序調整 |
| 7 | 主旨 | 主旨 | 保留 |
| 8 | 公文日期 | 公文日期 | 保留 |
| 9 | 收文日期 | 收文日期 | 保留 |
| 10 | 發文日期 | 發文日期 | 資料修復後有值 |
| 11 | 發文機關 | 發文單位 | 改名，合併清理代碼 |
| 12 | 受文機關 | 受文單位 | 改名，合併清理代碼 |
| 13 | 是否含附件 | 附件紀錄 | 改為統計數量（如 "3 個附件"） |
| 14 | - | 狀態 | 順序調整 |
| 15 | - | 承攬案件 | 順序調整 |
| 16 | 建立時間 | 建立時間 | 保留 |
| 17 | 更新時間 | 更新時間 | 保留 |
| - | 承辦人 | - | 移除（無資料） |
| - | 雲端連結 | - | 移除（不需要） |

### 最終欄位順序（17 欄）
```
公文ID → 流水號 → 發文形式 → 類別 → 公文類型 → 公文字號 → 主旨 →
公文日期 → 收文日期 → 發文日期 → 發文單位 → 受文單位 →
附件紀錄 → 狀態 → 承攬案件 → 建立時間 → 更新時間
```

---

## 四、修改的檔案清單

| 檔案路徑 | 修改內容 |
|---------|---------|
| `backend/app/api/endpoints/documents_enhanced.py` | 新增 Excel 匯出端點、調整欄位格式 |
| `backend/app/services/csv_processor.py` | 修正發文日期欄位對應 |
| `backend/main.py` | CORS 暴露 Content-Disposition header |
| `frontend/src/utils/exportUtils.ts` | 支援 RFC 5987 UTF-8 檔名解析 |
| `docs/document_fields_mapping.csv` | 更新欄位對照文件 |

---

## 五、測試驗證

### 匯出測試結果
```
檔名: 乾坤測繪公文總表20260107.xlsx
欄位數: 17
總筆數: 510
附件範例: S0170 → "3 個附件"
```

### 日期欄位驗證
| 類別 | 筆數 | 公文日期 | 收文日期 | 發文日期 |
|------|------|----------|----------|----------|
| 收文 | 337 | 336 ✓ | 337 ✓ | 0 (正確) |
| 發文 | 173 | 173 ✓ | 0 (正確) | 173 ✓ |

---

## 六、相關文件

- `docs/document_fields_mapping.csv` - 資料庫欄位對照表
- `docs/TODO.md` - 待辦事項（含備份機制規劃）
- `docs/CSV_IMPORT_MAINTENANCE.md` - CSV 匯入維護指南
