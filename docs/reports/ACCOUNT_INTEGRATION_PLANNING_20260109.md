# å¸³è™Ÿæ•´åˆç®¡ç†è¦åŠƒå ±å‘Š

> **å ±å‘Šæ—¥æœŸ**: 2026-01-09
> **å ±å‘Šç‰ˆæœ¬**: v1.1.0
> **è©•ä¼°ç¯„åœ**: å¸³è™Ÿç³»çµ±èˆ‡å¯©è¨ˆæœå‹™æ•´åˆæ¶æ§‹
> **èªè­‰ç­–ç•¥**: ğŸ”’ **åƒ… Google OAuth** (é™ä½ç®¡ç†é¢¨éšª)

---

## ã€‡ã€èªè­‰ç­–ç•¥æ±ºç­–

### æ±ºç­–æ‘˜è¦

| é …ç›® | æ±ºç­– | ç†ç”± |
|------|------|------|
| **ä¸»è¦èªè­‰** | Google OAuth | ä¼æ¥­æ¨™æº–ã€å®‰å…¨æ€§é«˜ |
| **å‚³çµ±å¸³å¯†** | âŒ ä¸æä¾› | é™ä½å¯†ç¢¼ç®¡ç†é¢¨éšª |
| **ä¿¡ç®±è¨»å†Š** | âŒ ä¸æä¾› | ç°¡åŒ–å¸³è™Ÿç®¡ç† |

### é¢¨éšªé™ä½æ•ˆç›Š

| é¢¨éšªé¡å‹ | å‚³çµ±å¸³å¯† | Google OAuth |
|----------|----------|--------------|
| å¯†ç¢¼å¤–æ´© | ğŸ”´ é«˜é¢¨éšª | âœ… ç„¡æ­¤é¢¨éšª |
| å¼±å¯†ç¢¼æ”»æ“Š | ğŸ”´ é«˜é¢¨éšª | âœ… ç„¡æ­¤é¢¨éšª |
| å¯†ç¢¼é‡è¨­è² æ“” | ğŸŸ¡ ç®¡ç†æˆæœ¬ | âœ… ç”± Google è™•ç† |
| å¸³è™Ÿè¢«ç›œ | ğŸŸ¡ éœ€è‡ªè¡Œåµæ¸¬ | âœ… Google 2FA ä¿è­· |
| èº«ä»½å†’ç”¨ | ğŸŸ¡ é›£ä»¥é©—è­‰ | âœ… Google èº«ä»½é©—è­‰ |

### ç°¡åŒ–å¾Œæ¶æ§‹

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Google OAuth  â”‚
                    â”‚   (å”¯ä¸€å…¥å£)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                CK_Missive ç³»çµ±                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ èº«ä»½é©—è­‰     â”‚    â”‚ æ¬Šé™ç®¡ç†                  â”‚  â”‚
â”‚  â”‚ (Google JWT) â”‚ â†’ â”‚ (å…§éƒ¨ RBAC)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸€ã€ç¾æœ‰ç³»çµ±æ¶æ§‹åˆ†æ

### 1.1 å¸³è™Ÿç®¡ç†æ¨¡çµ„ (ç°¡åŒ–å¾Œ)

| å…ƒä»¶ | æª”æ¡ˆä½ç½® | åŠŸèƒ½èªªæ˜ | ç‹€æ…‹ |
|------|----------|----------|------|
| User Model | `app/extended/models.py:192-216` | ä½¿ç”¨è€…è³‡æ–™æ¨¡å‹ | ä¿ç•™ |
| UserSession Model | `app/extended/models.py:356-374` | æœƒè©±ç®¡ç†æ¨¡å‹ | ä¿ç•™ |
| AuthService | `app/core/auth_service.py` | Google OAuth èªè­‰ | **ç°¡åŒ–** |
| user_management.py | `app/api/endpoints/user_management.py` | ç”¨æˆ¶æ¬Šé™ç®¡ç† | **ç°¡åŒ–** |
| auth.py | `app/api/endpoints/auth.py` | Google ç™»å…¥ API | **ç°¡åŒ–** |

### 1.2 User æ¨¡å‹æ¬„ä½ (ç²¾ç°¡)

```python
class User(Base):
    # æ ¸å¿ƒæ¬„ä½
    id: int                  # ä¸»éµ
    email: str               # Google ä¿¡ç®±ï¼ˆå”¯ä¸€ï¼Œä¸»è¦è­˜åˆ¥ï¼‰
    google_id: str           # Google OAuth IDï¼ˆå¿…å¡«ï¼‰
    full_name: str           # Google å§“å
    avatar_url: str          # Google é ­åƒ

    # ç‹€æ…‹æ¬„ä½
    is_active: bool          # å¸³è™Ÿç‹€æ…‹ï¼ˆç®¡ç†å“¡æ§åˆ¶ï¼‰
    is_admin: bool           # ç®¡ç†å“¡æ¨™è¨˜
    is_superuser: bool       # è¶…ç´šç®¡ç†å“¡æ¨™è¨˜

    # æ¬Šé™æ¬„ä½
    permissions: Text        # æ¬Šé™ JSON å­—ä¸²
    role: str                # è§’è‰² (user/admin/superuser)

    # è¿½è¹¤æ¬„ä½
    login_count: int         # ç™»å…¥æ¬¡æ•¸
    last_login: DateTime     # æœ€å¾Œç™»å…¥æ™‚é–“
    created_at: DateTime     # é¦–æ¬¡ç™»å…¥æ™‚é–“

    # æ£„ç”¨æ¬„ä½ (ä¿ç•™ä½†ä¸ä½¿ç”¨)
    # username: str          # æ”¹ç”¨ email
    # password_hash: str     # ä¸éœ€è¦
    # auth_provider: str     # å›ºå®šç‚º 'google'
    # email_verified: bool   # Google å·²é©—è­‰
```

### 1.3 æ¬Šé™ç³»çµ±æ¶æ§‹ (ç°¡åŒ–)

**è§’è‰²å±¤ç´š**:
```
superuser (è¶…ç´šç®¡ç†å“¡) â†’ æ‰€æœ‰æ¬Šé™ (*) â†’ åˆå§‹ç®¡ç†å“¡ Google å¸³è™Ÿ
    â†“
admin (ç®¡ç†å“¡) â†’ å®Œæ•´æ¥­å‹™æ¬Šé™ â†’ ç”±è¶…ç´šç®¡ç†å“¡æˆæ¬Š
    â†“
user (ä¸€èˆ¬ä½¿ç”¨è€…) â†’ åŸºæœ¬è®€å–æ¬Šé™ â†’ é¦–æ¬¡ Google ç™»å…¥è‡ªå‹•å»ºç«‹
```

**ç§»é™¤**: `unverified` è§’è‰²ï¼ˆGoogle å¸³è™Ÿå³å·²é©—è­‰ï¼‰

**æ¬Šé™æ¸…å–®**:
- å…¬æ–‡: `documents:read|create|edit|delete|export`
- å°ˆæ¡ˆ: `projects:read|create|edit|delete`
- æ©Ÿé—œ: `agencies:read|create|edit|delete`
- å» å•†: `vendors:read|create|edit|delete`
- ç³»çµ±: `admin:users|settings|database|site_management`
- å ±è¡¨: `reports:view|export`
- è¡Œäº‹æ›†: `calendar:read|edit`

---

## äºŒã€å¯©è¨ˆæœå‹™æ•´åˆæ–¹æ¡ˆ

### 2.1 æ•´åˆç›®æ¨™

1. **å®Œæ•´è¿½è¹¤**: è¨˜éŒ„æ‰€æœ‰å¸³è™Ÿç›¸é—œæ“ä½œï¼ˆç™»å…¥ã€ç™»å‡ºã€æ¬Šé™è®Šæ›´ï¼‰
2. **å®‰å…¨éš”é›¢**: å¯©è¨ˆè¨˜éŒ„å¤±æ•—ä¸å½±éŸ¿ä¸»æ¥­å‹™
3. **æŸ¥è©¢æ•ˆç‡**: æ”¯æ´æŒ‰ä½¿ç”¨è€…ã€æ™‚é–“ã€æ“ä½œé¡å‹æŸ¥è©¢
4. **åˆè¦æ”¯æ´**: æ»¿è¶³ä¼æ¥­ç¨½æ ¸éœ€æ±‚

### 2.2 å»ºè­°æ•´åˆé»

#### A. èªè­‰äº‹ä»¶å¯©è¨ˆ

| äº‹ä»¶é¡å‹ | è§¸ç™¼æ™‚æ©Ÿ | è¨˜éŒ„å…§å®¹ |
|----------|----------|----------|
| `LOGIN_SUCCESS` | ç™»å…¥æˆåŠŸ | user_id, IP, User-Agent |
| `LOGIN_FAILED` | ç™»å…¥å¤±æ•— | username/email, IP, å¤±æ•—åŸå›  |
| `LOGOUT` | ä½¿ç”¨è€…ç™»å‡º | user_id, session_jti |
| `TOKEN_REFRESH` | Token åˆ·æ–° | user_id, old_jti, new_jti |
| `SESSION_EXPIRED` | æœƒè©±éæœŸ | user_id, session_jti |
| `SESSION_REVOKED` | æœƒè©±æ’¤éŠ· | user_id, session_jti, åŸ·è¡Œè€… |

#### B. å¸³è™Ÿç®¡ç†å¯©è¨ˆ

| äº‹ä»¶é¡å‹ | è§¸ç™¼æ™‚æ©Ÿ | è¨˜éŒ„å…§å®¹ |
|----------|----------|----------|
| `USER_CREATED` | æ–°å¢ä½¿ç”¨è€… | æ–°ä½¿ç”¨è€… ID, å»ºç«‹è€… |
| `USER_UPDATED` | æ›´æ–°ä½¿ç”¨è€… | user_id, è®Šæ›´æ¬„ä½ |
| `USER_DELETED` | åˆªé™¤ä½¿ç”¨è€… | user_id, åˆªé™¤è€… |
| `USER_ACTIVATED` | å•Ÿç”¨å¸³è™Ÿ | user_id, åŸ·è¡Œè€… |
| `USER_DEACTIVATED` | åœç”¨å¸³è™Ÿ | user_id, åŸ·è¡Œè€… |

#### C. æ¬Šé™è®Šæ›´å¯©è¨ˆ

| äº‹ä»¶é¡å‹ | è§¸ç™¼æ™‚æ©Ÿ | è¨˜éŒ„å…§å®¹ |
|----------|----------|----------|
| `PERMISSION_GRANTED` | æ–°å¢æ¬Šé™ | user_id, æ¬Šé™åç¨± |
| `PERMISSION_REVOKED` | ç§»é™¤æ¬Šé™ | user_id, æ¬Šé™åç¨± |
| `ROLE_CHANGED` | è§’è‰²è®Šæ›´ | user_id, åŸè§’è‰², æ–°è§’è‰² |

### 2.3 å¯¦ä½œæ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API Endpoints                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ auth.py  â”‚  â”‚ user_mgmt.py â”‚  â”‚ documents_enhanced   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚                      â”‚
        â–¼               â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AuditService (çµ±ä¸€å…¥å£)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ log_auth_event()    â† èªè­‰äº‹ä»¶                        â”‚   â”‚
â”‚  â”‚ log_user_change()   â† å¸³è™Ÿè®Šæ›´                        â”‚   â”‚
â”‚  â”‚ log_permission_change() â† æ¬Šé™è®Šæ›´                    â”‚   â”‚
â”‚  â”‚ log_document_change()   â† å…¬æ–‡è®Šæ›´ (å·²å¯¦ä½œ)           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                â”‚
â”‚                   ç¨ç«‹ AsyncSession                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   audit_logs    â”‚
                    â”‚   è³‡æ–™è¡¨         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€è©³ç´°å¯¦ä½œå»ºè­°

### 3.1 AuditService æ“´å±•

```python
# app/services/audit_service.py æ–°å¢æ–¹æ³•

class AuditService:
    # æ—¢æœ‰æ–¹æ³•...

    @classmethod
    async def log_auth_event(
        cls,
        event_type: str,  # LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT, etc.
        user_id: Optional[int] = None,
        username: Optional[str] = None,
        ip_address: Optional[str] = None,
        user_agent: Optional[str] = None,
        details: Optional[Dict] = None
    ) -> bool:
        """è¨˜éŒ„èªè­‰ç›¸é—œäº‹ä»¶"""
        return await cls.log_change(
            table_name="auth_events",
            record_id=user_id or 0,
            action=event_type,
            changes={
                "username": username,
                "ip_address": ip_address,
                "user_agent": user_agent,
                **(details or {})
            },
            user_id=user_id,
            source="AUTH"
        )

    @classmethod
    async def log_permission_change(
        cls,
        user_id: int,
        action: str,  # GRANT, REVOKE, ROLE_CHANGE
        permissions: List[str] = None,
        old_role: str = None,
        new_role: str = None,
        admin_id: int = None,
        admin_name: str = None
    ) -> bool:
        """è¨˜éŒ„æ¬Šé™è®Šæ›´äº‹ä»¶"""
        changes = {}
        if permissions:
            changes["permissions"] = permissions
        if old_role and new_role:
            changes["role"] = {"old": old_role, "new": new_role}

        return await cls.log_change(
            table_name="user_permissions",
            record_id=user_id,
            action=action,
            changes=changes,
            user_id=admin_id,
            user_name=admin_name,
            source="ADMIN"
        )
```

### 3.2 auth.py æ•´åˆ

```python
# ç™»å…¥æˆåŠŸå¾Œ
await AuditService.log_auth_event(
    event_type="LOGIN_SUCCESS",
    user_id=user.id,
    username=user.username,
    ip_address=ip_address,
    user_agent=user_agent
)

# ç™»å…¥å¤±æ•—
await AuditService.log_auth_event(
    event_type="LOGIN_FAILED",
    username=form_data.username,
    ip_address=ip_address,
    details={"reason": "invalid_credentials"}
)
```

### 3.3 user_management.py æ•´åˆ

```python
# æ›´æ–°ä½¿ç”¨è€…å¾Œ
await AuditService.log_change(
    table_name="users",
    record_id=user_id,
    action="UPDATE",
    changes=update_data,
    user_id=admin_user.id,
    user_name=admin_user.full_name,
    source="ADMIN"
)

# æ¬Šé™è®Šæ›´å¾Œ
await AuditService.log_permission_change(
    user_id=user_id,
    action="UPDATE",
    permissions=new_permissions,
    old_role=old_role,
    new_role=new_role,
    admin_id=admin_user.id,
    admin_name=admin_user.full_name
)
```

---

## å››ã€æœªä¾†æ“´å±•è¦åŠƒ

### 4.1 çŸ­æœŸç›®æ¨™ (1-2 é€±)

| é …ç›® | å„ªå…ˆç´š | èªªæ˜ |
|------|--------|------|
| ç™»å…¥å¯©è¨ˆæ•´åˆ | é«˜ | è¨˜éŒ„æ‰€æœ‰ç™»å…¥å˜—è©¦ |
| æ¬Šé™è®Šæ›´å¯©è¨ˆ | é«˜ | è¿½è¹¤æ¬Šé™ä¿®æ”¹æ­·å² |
| å¯©è¨ˆæ—¥èªŒæŸ¥è©¢ API | ä¸­ | æä¾›ç®¡ç†å“¡æŸ¥è©¢ä»‹é¢ |

### 4.2 ä¸­æœŸç›®æ¨™ (1-2 æœˆ)

| é …ç›® | èªªæ˜ |
|------|------|
| ç•°å¸¸ç™»å…¥åµæ¸¬ | åµæ¸¬ç•°å¸¸ç™»å…¥è¡Œç‚ºï¼ˆç•°åœ°ã€é »ç¹å¤±æ•—ï¼‰ |
| ç™»å…¥é€šçŸ¥ | æ•æ„Ÿå¸³è™Ÿç™»å…¥æ™‚ç™¼é€é€šçŸ¥ |
| æœƒè©±ä½µç™¼æ§åˆ¶ | é™åˆ¶åŒæ™‚ç™»å…¥è£ç½®æ•¸é‡ |
| å¯†ç¢¼ç­–ç•¥å¼·åŒ– | å¯†ç¢¼è¤‡é›œåº¦ã€éæœŸæé†’ |

### 4.3 é•·æœŸç›®æ¨™ (3-6 æœˆ)

| é …ç›® | èªªæ˜ |
|------|------|
| SSO æ•´åˆ | æ”¯æ´ä¼æ¥­ SSOï¼ˆSAML/OIDCï¼‰ |
| MFA äºŒéšæ®µé©—è­‰ | æ”¯æ´ TOTPã€SMS é©—è­‰ |
| çµ„ç¹”æ¶æ§‹ç®¡ç† | éƒ¨é–€ã€è·ä½ã€çµ„ç¹”æ¨¹ |
| é€²éšæ¬Šé™æ¨¡å‹ | RBAC â†’ ABAC æ“´å±• |

---

## äº”ã€å®‰å…¨æ€§è€ƒé‡ (Google OAuth å°ˆç”¨)

### 5.1 å®‰å…¨å„ªå‹¢

| é …ç›® | èªªæ˜ |
|------|------|
| âœ… ç„¡å¯†ç¢¼å„²å­˜ | ç³»çµ±ä¸å„²å­˜ä»»ä½•å¯†ç¢¼ï¼Œé›¶æ´©æ¼é¢¨éšª |
| âœ… Google 2FA | ä½¿ç”¨è€…å¯å•Ÿç”¨ Google å…©æ­¥é©Ÿé©—è­‰ |
| âœ… OAuth 2.0 æ¨™æº– | æ¥­ç•Œæ¨™æº–èªè­‰å”å®š |
| âœ… JWT Token æ©Ÿåˆ¶ | å…§éƒ¨ session ç®¡ç† |
| âœ… Session éæœŸæ§åˆ¶ | è‡ªå‹•ç™»å‡ºæ©Ÿåˆ¶ |

### 5.2 ç®¡ç†æ§åˆ¶é»

| æ§åˆ¶é … | èªªæ˜ |
|--------|------|
| **å¸³è™Ÿç™½åå–®** | å¯é™åˆ¶ç‰¹å®š Google ç¶²åŸŸ (å¦‚ @company.com) |
| **æ–°å¸³è™Ÿå¯©æ ¸** | é¦–æ¬¡ç™»å…¥è‡ªå‹•å»ºç«‹ï¼Œä½†å¯è¨­ç‚º `is_active=false` éœ€äººå·¥å•Ÿç”¨ |
| **æ¬Šé™ç®¡ç†** | ç®¡ç†å“¡å¯éš¨æ™‚èª¿æ•´ä½¿ç”¨è€…æ¬Šé™ |
| **æœƒè©±æ’¤éŠ·** | å¯å¼·åˆ¶ç™»å‡ºç‰¹å®šä½¿ç”¨è€…æ‰€æœ‰è£ç½® |

### 5.3 å»ºè­°é…ç½®

```python
# ç’°å¢ƒè®Šæ•¸é…ç½®å»ºè­°
GOOGLE_ALLOWED_DOMAINS = "company.com,partner.com"  # é™åˆ¶ç¶²åŸŸ
AUTO_ACTIVATE_NEW_USER = False  # æ–°å¸³è™Ÿéœ€å¯©æ ¸
SESSION_EXPIRE_MINUTES = 480    # 8 å°æ™‚å·¥ä½œæ—¥
```

---

## å…­ã€API ç«¯é»èª¿æ•´æ¸…å–®

### 6.1 ä¿ç•™ç«¯é»

| ç«¯é» | æ–¹æ³• | èªªæ˜ |
|------|------|------|
| `/auth/google` | POST | Google OAuth ç™»å…¥ï¼ˆä¸»è¦å…¥å£ï¼‰ |
| `/auth/refresh` | POST | Token åˆ·æ–° |
| `/auth/logout` | POST | ç™»å‡º |
| `/auth/me` | GET | å–å¾—ç•¶å‰ä½¿ç”¨è€… |
| `/auth/check` | GET | æª¢æŸ¥èªè­‰ç‹€æ…‹ |

### 6.2 æ£„ç”¨ç«¯é» (å»ºè­°ç§»é™¤)

| ç«¯é» | æ–¹æ³• | ç†ç”± |
|------|------|------|
| `/auth/login` | POST | å‚³çµ±å¸³å¯†ç™»å…¥ï¼Œä¸å†éœ€è¦ |
| `/auth/register` | POST | ä¿¡ç®±è¨»å†Šï¼Œä¸å†éœ€è¦ |
| `/users` (POST) | POST | ç®¡ç†å“¡æ–°å¢ä½¿ç”¨è€…ï¼Œæ”¹ç‚º Google ç™»å…¥è‡ªå‹•å»ºç«‹ |

### 6.3 èª¿æ•´ç«¯é»

| ç«¯é» | èª¿æ•´å…§å®¹ |
|------|----------|
| `/users/{id}` (PUT) | ç§»é™¤ password æ¬„ä½ |
| `/users/{id}/permissions` | ä¿ç•™ï¼Œæ¬Šé™ç®¡ç†æ ¸å¿ƒ |

---

## ä¸ƒã€å¯¦ä½œå„ªå…ˆé †åº (ç°¡åŒ–ç‰ˆ)

### Phase 1: èªè­‰ç°¡åŒ– (1 é€±)

```
Day 1-2:
â”œâ”€â”€ ç§»é™¤ /auth/login ç«¯é»
â”œâ”€â”€ ç§»é™¤ /auth/register ç«¯é»
â””â”€â”€ æ›´æ–°å‰ç«¯ç§»é™¤å¸³å¯†ç™»å…¥ UI

Day 3-4:
â”œâ”€â”€ è¨­å®š Google ç¶²åŸŸç™½åå–®
â”œâ”€â”€ æ–°å¸³è™Ÿå¯©æ ¸æ©Ÿåˆ¶ (is_active é è¨­ false)
â””â”€â”€ ç®¡ç†å“¡å•Ÿç”¨å¸³è™Ÿæµç¨‹

Day 5:
â”œâ”€â”€ æ¸¬è©¦ Google OAuth å®Œæ•´æµç¨‹
â””â”€â”€ æ–‡ä»¶æ›´æ–°
```

### Phase 2: å¯©è¨ˆæ•´åˆ (1 é€±)

```
Day 1-2:
â”œâ”€â”€ AuditService æ–°å¢ log_auth_event()
â””â”€â”€ Google ç™»å…¥/ç™»å‡ºå¯©è¨ˆè¨˜éŒ„

Day 3-4:
â”œâ”€â”€ æ¬Šé™è®Šæ›´å¯©è¨ˆ
â””â”€â”€ å¸³è™Ÿå•Ÿç”¨/åœç”¨å¯©è¨ˆ

Day 5:
â”œâ”€â”€ å¯©è¨ˆæ—¥èªŒæŸ¥è©¢ API
â””â”€â”€ ç®¡ç†ä»‹é¢æ•´åˆ
```

---

## å…«ã€çµè«–èˆ‡å»ºè­°

### 8.1 æ±ºç­–æ•ˆç›Š

| æ•ˆç›Š | èªªæ˜ |
|------|------|
| **é›¶å¯†ç¢¼é¢¨éšª** | ç³»çµ±ä¸è™•ç†ä»»ä½•å¯†ç¢¼ï¼Œå®Œå…¨æ¶ˆé™¤å¯†ç¢¼ç›¸é—œæ”»æ“Šé¢ |
| **ç°¡åŒ–ç¶­é‹** | ç„¡å¯†ç¢¼é‡è¨­ã€ç„¡å¸³è™Ÿé–å®šå•é¡Œ |
| **ä¼æ¥­ç´šå®‰å…¨** | ç¹¼æ‰¿ Google å®‰å…¨åŸºç¤è¨­æ–½ |
| **ä½¿ç”¨è€…é«”é©—** | ä¸€éµç™»å…¥ï¼Œç„¡éœ€è¨˜æ†¶å¯†ç¢¼ |

### 8.2 æ³¨æ„äº‹é …

| é …ç›® | èªªæ˜ |
|------|------|
| **Google ä¾è³´** | ç³»çµ±èªè­‰å®Œå…¨ä¾è³´ Google æœå‹™å¯ç”¨æ€§ |
| **ç¶²åŸŸé™åˆ¶** | å»ºè­°é™åˆ¶å…è¨±çš„ Google ç¶²åŸŸ |
| **é›¢ç·šå­˜å–** | éœ€è€ƒæ…® Google æœå‹™ä¸­æ–·æ™‚çš„é™ç´šæ–¹æ¡ˆ |

### 8.3 é ä¼°å·¥ä½œé‡ (ç²¾ç°¡å¾Œ)

| é …ç›® | é ä¼°æ™‚é–“ | è¤‡é›œåº¦ |
|------|----------|--------|
| ç§»é™¤å‚³çµ±ç™»å…¥ | 1 å¤© | ä½ |
| ç¶²åŸŸç™½åå–® | 0.5 å¤© | ä½ |
| æ–°å¸³è™Ÿå¯©æ ¸æ©Ÿåˆ¶ | 1 å¤© | ä½ |
| å¯©è¨ˆæœå‹™æ•´åˆ | 2 å¤© | ä½ |
| å‰ç«¯ UI èª¿æ•´ | 1 å¤© | ä½ |
| **ç¸½è¨ˆ** | **5.5 å¤©** | - |

---

## ä¹ã€é™„éŒ„ï¼šGoogle OAuth é…ç½®æ¸…å–®

### ç’°å¢ƒè®Šæ•¸

```env
# Google OAuth è¨­å®š
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret

# å®‰å…¨è¨­å®š
GOOGLE_ALLOWED_DOMAINS=company.com  # å…è¨±çš„ç¶²åŸŸï¼Œå¤šå€‹ç”¨é€—è™Ÿåˆ†éš”
AUTO_ACTIVATE_NEW_USER=false        # æ–°å¸³è™Ÿæ˜¯å¦è‡ªå‹•å•Ÿç”¨
REQUIRE_EMAIL_VERIFICATION=false    # Google å·²é©—è­‰ï¼Œç„¡éœ€å†é©—

# Session è¨­å®š
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

### åˆå§‹ç®¡ç†å“¡è¨­å®š

```sql
-- è¨­å®šåˆå§‹è¶…ç´šç®¡ç†å“¡ (é¦–æ¬¡éƒ¨ç½²å¾ŒåŸ·è¡Œ)
UPDATE users
SET is_superuser = true,
    is_admin = true,
    is_active = true,
    role = 'superuser'
WHERE email = 'admin@company.com';
```

---

*å ±å‘Šæ’°å¯«: Claude Code Assistant*
*ç‰ˆæœ¬: v1.1.0 (Google OAuth Only)*
*å¯©æ ¸ç‹€æ…‹: å¾…å¯©æ ¸*
